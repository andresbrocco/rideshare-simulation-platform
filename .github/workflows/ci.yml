name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint-and-typecheck:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/control-panel/package-lock.json

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.14.3'
          terraform_wrapper: false

      - name: Install TFLint
        uses: terraform-linters/setup-tflint@v4

      - name: Init TFLint plugins
        run: tflint --init --config .tflint.hcl

      - name: Install pre-commit
        run: pip install pre-commit

      - name: Create venvs and install dependencies for all services
        run: |
          # simulation - install full dev dependencies for type stubs
          python -m venv services/simulation/venv
          services/simulation/venv/bin/pip install --quiet -e "services/simulation/[dev]"
          # Install boto3 type stubs and opentelemetry packages for type checking
          services/simulation/venv/bin/pip install --quiet "boto3-stubs[essential]"

          # stream-processor - install with opentelemetry packages
          python -m venv services/stream-processor/venv
          services/stream-processor/venv/bin/pip install --quiet -e "services/stream-processor/[dev]"

          # dbt - install with pyspark and pyhive for type checking
          python -m venv tools/dbt/venv
          tools/dbt/venv/bin/pip install --quiet mypy pyspark pyhive

          # airflow - install with runtime dependencies for type checking
          python -m venv services/airflow/venv
          services/airflow/venv/bin/pip install --quiet mypy types-requests duckdb apache-airflow deltalake

          # great-expectations - install from requirements.txt
          python -m venv tools/great-expectations/venv
          tools/great-expectations/venv/bin/pip install --quiet mypy types-PyYAML
          tools/great-expectations/venv/bin/pip install --quiet -r tools/great-expectations/requirements.txt

          # lakehouse - install with pyspark and delta-spark
          python -m venv schemas/lakehouse/venv
          schemas/lakehouse/venv/bin/pip install --quiet mypy pyspark delta-spark

      - name: Install frontend dependencies
        run: npm ci
        working-directory: services/control-panel

      - name: Run pre-commit on all files
        run: pre-commit run --all-files

  unit-tests:
    needs: lint-and-typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.13
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install simulation dependencies and run tests
        working-directory: services/simulation
        run: |
          python -m venv venv
          ./venv/bin/pip install --quiet -e ".[dev]"
          ./venv/bin/pytest -v --tb=short

      - name: Install stream-processor dependencies and run tests
        working-directory: services/stream-processor
        run: |
          python -m venv venv
          ./venv/bin/pip install --quiet -e ".[dev]"
          ./venv/bin/pytest -v --tb=short

  frontend-build:
    needs: lint-and-typecheck
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/control-panel/package-lock.json

      - name: Install dependencies
        run: npm ci
        working-directory: services/control-panel

      - name: Build
        run: npm run build
        working-directory: services/control-panel

  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      api-changed: ${{ steps.filter.outputs.api }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            api:
              - 'services/simulation/src/api/**'
              - 'services/control-panel/src/**'
              - 'schemas/api/**'

  api-contract-validation:
    needs: [lint-and-typecheck, detect-changes]
    if: needs.detect-changes.outputs.api-changed == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip uv
          cd services/simulation
          uv pip install --system -r requirements.txt

      - name: Export OpenAPI spec
        run: |
          python services/simulation/scripts/export-openapi.py

      - name: Validate OpenAPI spec
        run: |
          cd services/simulation
          python -m pytest tests/test_api_contract.py::test_openapi_spec_is_valid -v

      - name: Install frontend dependencies
        run: |
          cd services/control-panel
          npm ci

      - name: Generate TypeScript types
        run: |
          cd services/control-panel
          npm run generate-types

      - name: Check TypeScript types match OpenAPI spec
        run: |
          cd services/simulation
          python -m pytest tests/test_api_contract.py::test_typescript_types_match_openapi -v

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: openapi-spec
          path: schemas/api/openapi.json
