name: API Contract Validation

on:
  pull_request:
    paths:
      - 'services/simulation/src/api/**'
      - 'services/frontend/src/**'
      - 'schemas/api/**'
  push:
    branches:
      - main
    paths:
      - 'services/simulation/src/api/**'
      - 'services/frontend/src/**'
      - 'schemas/api/**'

jobs:
  validate-contract:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip uv
          cd services/simulation
          uv pip install --system -r requirements.txt

      - name: Export OpenAPI spec
        run: |
          python services/simulation/scripts/export-openapi.py

      - name: Validate OpenAPI spec
        run: |
          cd services/simulation
          python -m pytest tests/test_api_contract.py::test_openapi_spec_is_valid -v

      - name: Install frontend dependencies
        run: |
          cd services/frontend
          npm ci

      - name: Generate TypeScript types
        run: |
          cd services/frontend
          npm run generate-types

      - name: Check TypeScript types match OpenAPI spec
        run: |
          cd services/simulation
          python -m pytest tests/test_api_contract.py::test_typescript_types_match_openapi -v

      - name: Upload OpenAPI spec artifact
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: openapi-spec
          path: schemas/api/openapi.json
