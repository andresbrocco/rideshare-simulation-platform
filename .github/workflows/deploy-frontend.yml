name: Deploy Frontend to S3

on:
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

jobs:
  deploy-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: services/frontend/package-lock.json

      - name: Install dependencies
        working-directory: services/frontend
        run: npm ci

      - name: Build React app with production environment variables
        working-directory: services/frontend
        env:
          VITE_API_URL: https://api.ridesharing.portfolio.andresbrocco.com
          VITE_WS_URL: wss://api.ridesharing.portfolio.andresbrocco.com/ws
        run: npm run build

      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/rideshare-github-actions
          aws-region: us-east-1

      - name: Sync build output to S3
        working-directory: services/frontend
        run: |
          BUCKET="rideshare-${{ secrets.AWS_ACCOUNT_ID }}-frontend"

          aws s3 sync dist/ "s3://${BUCKET}/" \
            --delete \
            --cache-control "public, max-age=31536000" \
            --exclude "index.html" \
            --exclude "*.html"

          aws s3 sync dist/ "s3://${BUCKET}/" \
            --exclude "*" \
            --include "*.html" \
            --cache-control "public, max-age=0, must-revalidate"

      - name: Invalidate CloudFront cache
        run: |
          DISTRIBUTION_ID=$(aws cloudfront list-distributions \
            --query "DistributionList.Items[?Comment=='Frontend SPA distribution'].Id" \
            --output text)

          if [ -z "$DISTRIBUTION_ID" ]; then
            echo "Error: CloudFront distribution not found"
            exit 1
          fi

          aws cloudfront create-invalidation \
            --distribution-id "$DISTRIBUTION_ID" \
            --paths "/*"

      - name: Output deployment summary
        run: |
          echo "Frontend deployed to S3 and CloudFront cache invalidated"
          echo "Frontend URL: https://ridesharing.portfolio.andresbrocco.com"
