apiVersion: 1

groups:
  - name: pipeline_failures
    folder: Alerts
    interval: 1m
    rules:
      - uid: kafka_consumer_lag_high
        title: High Kafka Consumer Lag
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(kafka_consumer_lag) > 10000
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Kafka consumer lag has exceeded 10,000 messages
          summary: High consumer lag detected
        labels:
          severity: warning
          component: kafka

      - uid: spark_job_failure
        title: Spark Job Failure
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: increase(spark_job_failed_total[5m]) > 0
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          description: Spark job has failed in the last 5 minutes
          summary: Spark job failure detected
        labels:
          severity: critical
          component: spark

      - uid: airflow_dag_failure
        title: Airflow DAG Failure
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: increase(airflow_dag_run_failed_total[5m]) > 0
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          description: Airflow DAG run has failed in the last 5 minutes
          summary: DAG run failure detected
        labels:
          severity: critical
          component: airflow

  - name: resource_thresholds
    folder: Alerts
    interval: 1m
    rules:
      - uid: kafka_memory_high
        title: High Kafka Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (container_memory_usage_bytes{name="rideshare-kafka"} / container_spec_memory_limit_bytes{name="rideshare-kafka"}) > 0.9
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Kafka container is using more than 90% of allocated memory
          summary: High memory usage on Kafka
        labels:
          severity: warning
          component: kafka

      - uid: spark_memory_high
        title: High Spark Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (container_memory_usage_bytes{name=~"rideshare-spark-.*"} / container_spec_memory_limit_bytes{name=~"rideshare-spark-.*"}) > 0.9
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Spark container is using more than 90% of allocated memory
          summary: High memory usage on Spark
        labels:
          severity: warning
          component: spark

      - uid: container_cpu_high
        title: High Container CPU Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(container_cpu_usage_seconds_total{name=~"rideshare-.*"}[5m]) > 0.8
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Container CPU usage has exceeded 80% for 5 minutes
          summary: High CPU usage detected
        labels:
          severity: warning
          component: infrastructure
