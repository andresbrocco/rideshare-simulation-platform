apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

# Production overlay for AWS EKS
# Uses real AWS services (S3, RDS, Secrets Manager, ALB) instead of local alternatives

resources:
  # Core Services
  - ../../manifests/kafka.yaml
  - ../../manifests/schema-registry.yaml
  - ../../manifests/redis.yaml
  - ../../manifests/osrm.yaml
  - ../../manifests/simulation.yaml
  - ../../manifests/stream-processor.yaml
  - ../../manifests/performance-controller.yaml
  - ../../manifests/control-panel.yaml

  # Data Pipeline
  - ../../manifests/bronze-ingestion.yaml
  - ../../manifests/bronze-init.yaml
  - ../../manifests/hive-metastore.yaml
  - ../../manifests/trino.yaml
  - ../../manifests/airflow-webserver.yaml
  - ../../manifests/airflow-scheduler.yaml
  - ../../manifests/airflow-dags.yaml

  # Monitoring
  - ../../manifests/prometheus.yaml
  - ../../manifests/grafana.yaml
  - ../../manifests/loki.yaml
  - ../../manifests/tempo.yaml
  - ../../manifests/otel-collector.yaml

  # External Secrets (syncs from AWS Secrets Manager)
  - ../../manifests/external-secrets-namespace.yaml
  - secretstore-aws-patch.yaml  # replaces base localstack-secrets SecretStore
  - ../../manifests/external-secrets-api-keys.yaml
  - ../../manifests/external-secrets-app-credentials.yaml

  # IRSA ServiceAccounts (pods assume IAM roles via projected tokens)
  - serviceaccount-irsa-patches.yaml

  # Prometheus RBAC (ServiceAccount + ClusterRole for Kubernetes SD)
  - prometheus-rbac.yaml

  # Storage (EBS gp3 replaces local-path provisioner)
  - storageclass-ebs.yaml

  # ConfigMaps (patched below)
  - ../../manifests/configmap-core.yaml
  - ../../manifests/configmap-data-pipeline.yaml

  # ALB Ingress (per-service subdomain routing via IngressGroup)
  - ingress-api.yaml
  - ingress-grafana.yaml
  - ingress-airflow.yaml
  - ingress-trino.yaml
  - ingress-prometheus.yaml
  - ingress-control-panel.yaml

namespace: rideshare-prod

# Generate ConfigMaps from source files so ArgoCD manages them
configMapGenerator:
  - name: airflow-init-scripts
    options:
      disableNameSuffixHash: true
    files:
      - export-dbt-to-s3.py=../../../scripts/export-dbt-to-s3.py
      - register-trino-tables.py=../../../scripts/register-trino-tables.py

  - name: airflow-dbt-project
    options:
      disableNameSuffixHash: true
    files:
      - dbt-project.tar.gz

images:
  # Custom service images from ECR (placeholders resolved during deploy)
  # <account-id> → AWS account ID, <image-tag> → git SHA for immutable deploys
  - name: rideshare-simulation
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/simulation
    newTag: <image-tag>
  - name: rideshare-stream-processor
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/stream-processor
    newTag: <image-tag>
  - name: rideshare-performance-controller
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/performance-controller
    newTag: <image-tag>
  - name: rideshare-control-panel
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/control-panel
    newTag: <image-tag>
  - name: rideshare-bronze-ingestion
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/bronze-ingestion
    newTag: <image-tag>
  - name: rideshare-hive-metastore
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/hive-metastore
    newTag: <image-tag>
  - name: rideshare-osrm
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/osrm
    newTag: <image-tag>
  - name: otel/opentelemetry-collector-contrib
    newName: <account-id>.dkr.ecr.us-east-1.amazonaws.com/rideshare/otel-collector
    newTag: <image-tag>

patches:
  # Override imagePullPolicy from Never (local dev) to IfNotPresent (SHA tags are immutable)
  - patch: '[{"op": "replace", "path": "/spec/template/spec/containers/0/imagePullPolicy", "value": "IfNotPresent"}]'
    target:
      kind: Deployment
      labelSelector: app in (simulation,stream-processor,performance-controller,control-panel,bronze-ingestion,hive-metastore,osrm,otel-collector)
  - patch: '[{"op": "replace", "path": "/spec/template/spec/containers/0/imagePullPolicy", "value": "IfNotPresent"}]'
    target:
      kind: StatefulSet
      name: kafka

  # ConfigMap patches for production environment
  - path: configmap-core-patch.yaml
    target:
      kind: ConfigMap
      name: core-config

  - path: configmap-data-pipeline-patch.yaml
    target:
      kind: ConfigMap
      name: data-pipeline-config

  # Bind Deployments to their IRSA ServiceAccounts
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            serviceAccountName: simulation
    target:
      kind: Deployment
      name: simulation

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            serviceAccountName: bronze-ingestion
    target:
      kind: Deployment
      name: bronze-ingestion

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            serviceAccountName: airflow-scheduler
    target:
      kind: Deployment
      name: airflow-scheduler

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            serviceAccountName: airflow-webserver
    target:
      kind: Deployment
      name: airflow-webserver

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            serviceAccountName: trino
    target:
      kind: Deployment
      name: trino

  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            serviceAccountName: hive-metastore
    target:
      kind: Deployment
      name: hive-metastore

  # Point ExternalSecrets to production SecretStore
  - patch: |-
      apiVersion: external-secrets.io/v1beta1
      kind: ExternalSecret
      metadata:
        name: placeholder
      spec:
        secretStoreRef:
          name: aws-secrets-manager
    target:
      kind: ExternalSecret

  # Core service manifests - Tickets 022-023

  # Kafka: EBS-backed PVC replaces emptyDir for data persistence
  - path: kafka-patch.yaml
    target:
      kind: StatefulSet
      name: kafka

  # Hive Metastore: RDS endpoint, remove MinIO initContainer and credentials
  - path: hive-metastore-patch.yaml
    target:
      kind: Deployment
      name: hive-metastore

  # Hive site config: AWS S3 via IRSA instead of MinIO endpoint and credentials
  - path: hive-site-config-patch.yaml
    target:
      kind: ConfigMap
      name: hive-site-config

  # Trino catalog: Remove MinIO S3 endpoint and static credentials
  - path: trino-catalog-patch.yaml
    target:
      kind: ConfigMap
      name: trino-config

  # Trino deployment: Remove MinIO initContainer and credential references
  - path: trino-patch.yaml
    target:
      kind: Deployment
      name: trino

  # Pipeline and monitoring manifests - Ticket 023

  # Airflow: RDS connection, subpath serving, remove MinIO endpoint
  - path: airflow-webserver-patch.yaml
    target:
      kind: Deployment
      name: airflow-webserver

  - path: airflow-scheduler-patch.yaml
    target:
      kind: Deployment
      name: airflow-scheduler

  # Bronze Ingestion: Remove MinIO dependencies, use IRSA for S3
  - path: bronze-ingestion-patch.yaml
    target:
      kind: Deployment
      name: bronze-ingestion

  # Bronze Init: Override S3 bucket name for production
  - path: bronze-init-patch.yaml
    target:
      kind: CronJob
      name: bronze-init

  # Simulation: Production domain, S3 checkpoints, deployment env
  - path: simulation-patch.yaml
    target:
      kind: Deployment
      name: simulation

  # Grafana: Production domain URL, disable anonymous access
  - path: grafana-patch.yaml
    target:
      kind: Deployment
      name: grafana

  # Redis: Enable authentication with password from secrets
  - path: redis-patch.yaml
    target:
      kind: Deployment
      name: redis

  # Prometheus: Bind to ServiceAccount for Kubernetes SD RBAC
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            serviceAccountName: prometheus
    target:
      kind: Deployment
      name: prometheus

  # Prometheus: Kubernetes SD, kube-state-metrics, annotation-based pod discovery
  - path: prometheus-config-patch.yaml
    target:
      kind: ConfigMap
      name: prometheus-config

  # Prometheus: Production recording rules with Kubernetes label selectors
  - path: prometheus-rules-patch.yaml
    target:
      kind: ConfigMap
      name: prometheus-rules

  # Performance Controller: production deployment environment
  - patch: |-
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder
      spec:
        template:
          spec:
            containers:
              - name: performance-controller
                env:
                  - name: DEPLOYMENT_ENV
                    value: "production"
    target:
      kind: Deployment
      name: performance-controller
