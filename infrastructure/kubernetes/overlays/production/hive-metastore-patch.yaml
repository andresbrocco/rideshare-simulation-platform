# Production patch: Point Hive Metastore to RDS and remove MinIO dependencies
# - Removes wait-for-minio initContainer (no MinIO in production)
# - Updates postgres readiness check to target RDS endpoint
# - Removes MINIO_ROOT_USER / MINIO_ROOT_PASSWORD env vars (IRSA handles S3)
# - Overrides container command to build SERVICE_OPTS from env vars at runtime
#   (avoids Kubernetes $(VAR) expansion ordering issues with Kustomize merge
#    and XML-special characters in passwords breaking hive-site.xml)
#
# Replace rideshare-postgres.c8zsec64gwhw.us-east-1.rds.amazonaws.com with Terraform output during deploy:
#   terraform -chdir=infrastructure/terraform/platform output -raw rds_endpoint
apiVersion: apps/v1
kind: Deployment
metadata:
  name: hive-metastore
spec:
  template:
    spec:
      initContainers:
        - name: wait-for-minio
          $patch: delete
        - name: wait-for-postgres-metastore
          command:
            - sh
            - -c
            - |
              until nc -z rideshare-postgres.c8zsec64gwhw.us-east-1.rds.amazonaws.com 5432; do
                echo "Waiting for RDS PostgreSQL..."
                sleep 2
              done
              echo "RDS PostgreSQL is ready"
      containers:
        - name: hive-metastore
          command:
            - bash
            - -c
            - |
              # Build SERVICE_OPTS from env vars at runtime to avoid:
              # 1. Kubernetes $(VAR) expansion ordering issues after Kustomize merge
              # 2. XML-special characters in passwords breaking hive-site.xml
              export SERVICE_OPTS="-Djavax.jdo.option.ConnectionDriverName=org.postgresql.Driver \
              -Djavax.jdo.option.ConnectionURL=jdbc:postgresql://rideshare-postgres.c8zsec64gwhw.us-east-1.rds.amazonaws.com:5432/metastore \
              -Djavax.jdo.option.ConnectionUserName=${POSTGRES_METASTORE_USER} \
              -Djavax.jdo.option.ConnectionPassword=${POSTGRES_METASTORE_PASSWORD}"
              # No envsubst needed â€” production hive-site.xml has no env var placeholders
              cp /opt/hive/conf/hive-site.xml.template /opt/hive/conf/hive-site.xml
              exec /entrypoint.sh
          env:
            - name: MINIO_ROOT_USER
              $patch: delete
            - name: MINIO_ROOT_PASSWORD
              $patch: delete
            - name: AWS_REGION
              value: "us-east-1"
