apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  labels:
    app: grafana
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      - name: Prometheus
        uid: prometheus
        type: prometheus
        access: proxy
        url: http://prometheus:9090
        isDefault: true
        editable: false
        jsonData:
          timeInterval: 15s

      - name: Trino
        uid: trino
        type: trino-datasource
        access: proxy
        url: http://trino:8080
        isDefault: false
        editable: false
        jsonData:
          catalog: delta

      - name: Loki
        uid: loki
        type: loki
        access: proxy
        url: http://loki:3100
        isDefault: false
        editable: false
        jsonData:
          maxLines: 1000

      - name: Tempo
        uid: tempo
        type: tempo
        access: proxy
        url: http://tempo:3200
        isDefault: false
        editable: false
        jsonData:
          tracesToLogsV2:
            datasourceUid: loki
            filterByTraceID: true
            filterBySpanID: true
          tracesToMetrics:
            datasourceUid: prometheus
          nodeGraph:
            enabled: true
          serviceMap:
            datasourceUid: prometheus

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  labels:
    app: grafana
data:
  default.yml: |
    apiVersion: 1

    providers:
      # Monitoring folder (existing simulation-metrics dashboard)
      - name: 'monitoring'
        orgId: 1
        folder: 'Monitoring'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /etc/dashboards/monitoring

      # Data Engineering folder (Bronze/Silver dashboards)
      - name: 'data-engineering'
        orgId: 1
        folder: 'Data Engineering'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /etc/dashboards/data-engineering

      # Business Intelligence folder (Gold dashboards)
      - name: 'business-intelligence'
        orgId: 1
        folder: 'Business Intelligence'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /etc/dashboards/business-intelligence

      # Operations folder (Platform Operations dashboard)
      - name: 'operations'
        orgId: 1
        folder: 'Operations'
        type: file
        disableDeletion: false
        updateIntervalSeconds: 10
        allowUiUpdates: true
        options:
          path: /etc/dashboards/operations

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-monitoring
  labels:
    app: grafana
data:
  simulation-metrics.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "Real-time operational monitoring of the rideshare simulation engine. Tracks driver/rider activity, trip quality SLAs, event throughput, dependency latencies (OSRM, Kafka, Redis), error rates, and container resource usage. Data sourced from Prometheus via OpenTelemetry.",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 0,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "Business Overview",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 10
                  },
                  {
                    "color": "green",
                    "value": 50
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "description": "Current number of drivers in available status, ready to accept ride offers. Color thresholds: red (<10), yellow (<50), green (50+). Sourced from simulation_drivers_available up-down counter.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_drivers_available",
              "legendFormat": "Drivers Available",
              "refId": "A"
            }
          ],
          "title": "Drivers Available",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 1
          },
          "id": 3,
          "description": "Riders currently traveling inside a vehicle (trips in STARTED state). Sourced from simulation_riders_in_transit.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_riders_in_transit",
              "legendFormat": "Riders In Transit",
              "refId": "A"
            }
          ],
          "title": "Riders In Transit",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 1
          },
          "id": 4,
          "description": "Trips in any non-terminal state (REQUESTED through STARTED). Excludes COMPLETED and CANCELLED.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_trips_active",
              "legendFormat": "Active Trips",
              "refId": "A"
            }
          ],
          "title": "Active Trips",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "purple",
                    "value": null
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 1
          },
          "id": 5,
          "description": "Percentage of ride offers accepted by drivers. Values below 80% may indicate supply/demand imbalance or driver DNA with low acceptance rates.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_matching_success_rate_percent",
              "legendFormat": "Matching Rate",
              "refId": "A"
            }
          ],
          "title": "Matching Success Rate",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
          },
          "id": 6,
          "panels": [],
          "title": "Trip Quality Metrics",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "currencyUSD"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 6,
            "w": 6,
            "x": 0,
            "y": 6
          },
          "id": 7,
          "description": "Rolling-window average fare across recently completed trips (USD). Reflects base pricing, distance distribution, and active surge multipliers across São Paulo zones.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_avg_fare_dollars",
              "legendFormat": "Avg Fare",
              "refId": "A"
            }
          ],
          "title": "Average Fare",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "m"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 6,
            "w": 6,
            "x": 6,
            "y": 6
          },
          "id": 8,
          "description": "Mean duration of completed trips. Affected by distance distribution and simulated traffic patterns in the São Paulo region.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_avg_duration_minutes",
              "legendFormat": "Avg Duration",
              "refId": "A"
            }
          ],
          "title": "Average Duration (min)",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 6,
            "w": 6,
            "x": 12,
            "y": 6
          },
          "id": 9,
          "description": "Average time riders wait from match to driver arrival (MATCHED to DRIVER_ARRIVED). Core rider experience SLA metric.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_avg_wait_seconds",
              "legendFormat": "Avg Wait",
              "refId": "A"
            }
          ],
          "title": "Average Wait Time",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 6,
            "w": 6,
            "x": 18,
            "y": 6
          },
          "id": 10,
          "description": "Average time from driver arrival to trip start (DRIVER_ARRIVED to STARTED). High values may indicate pickup coordination issues.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_avg_pickup_seconds",
              "legendFormat": "Avg Pickup",
              "refId": "A"
            }
          ],
          "title": "Average Pickup Time",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 12
          },
          "id": 11,
          "panels": [],
          "title": "Event Throughput",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "ops"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 13
          },
          "id": 12,
          "description": "Event production rate broken down by event type (TRIP_REQUESTED, OFFER_SENT, MATCHED, etc.). Each event type corresponds to a trip state machine transition. Stacked to show composition.",
          "options": {
            "legend": {
              "calcs": ["mean", "last"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum(rate(simulation_events_total[$__rate_interval])) by (event_type)",
              "legendFormat": "{{event_type}}",
              "refId": "A"
            }
          ],
          "title": "Events/sec by Type",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "ops"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 12,
            "y": 13
          },
          "id": 13,
          "description": "Aggregate event throughput across all event types. Indicates overall simulation engine activity level.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum(rate(simulation_events_total[$__rate_interval]))",
              "legendFormat": "Total Events/sec",
              "refId": "A"
            }
          ],
          "title": "Total Events/sec",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 500
                  },
                  {
                    "color": "red",
                    "value": 1000
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 18,
            "y": 13
          },
          "id": 14,
          "description": "Internal backpressure indicators. SimPy Queue = discrete-event engine backlog (high values mean simulation is falling behind real-time). Pending Offers = unaccepted ride offers held by drivers.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_simpy_events",
              "legendFormat": "SimPy Queue",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_offers_pending",
              "legendFormat": "Pending Offers",
              "refId": "B"
            }
          ],
          "title": "Queue Depths",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 20
          },
          "id": 15,
          "panels": [],
          "title": "Latency Histograms",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 8,
            "x": 0,
            "y": 21
          },
          "id": 16,
          "description": "Response time percentiles (p50/p95/p99) for OSRM routing service calls. OSRM calculates driving distances and ETAs for trip matching and fare estimation.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.50, rate(simulation_osrm_latency_seconds_bucket[$__rate_interval]))",
              "legendFormat": "p50",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.95, rate(simulation_osrm_latency_seconds_bucket[$__rate_interval]))",
              "legendFormat": "p95",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.99, rate(simulation_osrm_latency_seconds_bucket[$__rate_interval]))",
              "legendFormat": "p99",
              "refId": "C"
            }
          ],
          "title": "OSRM Latency",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 8,
            "x": 8,
            "y": 21
          },
          "id": 17,
          "description": "Publish latency percentiles (p50/p95/p99) for Kafka event broker. Measures time from event creation to broker acknowledgment.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.50, rate(simulation_kafka_latency_seconds_bucket[$__rate_interval]))",
              "legendFormat": "p50",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.95, rate(simulation_kafka_latency_seconds_bucket[$__rate_interval]))",
              "legendFormat": "p95",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.99, rate(simulation_kafka_latency_seconds_bucket[$__rate_interval]))",
              "legendFormat": "p99",
              "refId": "C"
            }
          ],
          "title": "Kafka Latency",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 8,
            "x": 16,
            "y": 21
          },
          "id": 18,
          "description": "Operation latency percentiles (p50/p95/p99) for Redis. Redis stores real-time state and serves as the pub/sub bridge to the frontend WebSocket layer.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.50, rate(simulation_redis_latency_seconds_bucket[$__rate_interval])) or vector(0)",
              "legendFormat": "p50",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.95, rate(simulation_redis_latency_seconds_bucket[$__rate_interval])) or vector(0)",
              "legendFormat": "p95",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "histogram_quantile(0.99, rate(simulation_redis_latency_seconds_bucket[$__rate_interval])) or vector(0)",
              "legendFormat": "p99",
              "refId": "C"
            }
          ],
          "title": "Redis Latency",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 28
          },
          "id": 19,
          "panels": [],
          "title": "Errors & Health",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "normal"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 1
                  },
                  {
                    "color": "red",
                    "value": 5
                  }
                ]
              },
              "unit": "ops"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 29
          },
          "id": 20,
          "description": "Error rate broken down by component (matching, payment, kafka, osrm, redis). Stacked to show which subsystems contribute most to failures.",
          "options": {
            "legend": {
              "calcs": ["sum"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum(rate(simulation_errors_total[$__rate_interval])) by (component)",
              "legendFormat": "{{component}}",
              "refId": "A"
            }
          ],
          "title": "Errors/sec by Component",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [
                {
                  "options": {
                    "0": {
                      "color": "red",
                      "index": 1,
                      "text": "Disconnected"
                    },
                    "1": {
                      "color": "green",
                      "index": 0,
                      "text": "Connected"
                    }
                  },
                  "type": "value"
                }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "green",
                    "value": 1
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 12,
            "y": 29
          },
          "id": 21,
          "description": "Binary health indicators for the stream processor's Kafka consumer and Redis publisher connections. Green = connected, Red = disconnected.",
          "options": {
            "colorMode": "background",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "vertical",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "stream_processor_kafka_connected",
              "legendFormat": "Kafka",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "stream_processor_redis_connected",
              "legendFormat": "Redis",
              "refId": "B"
            }
          ],
          "title": "Stream Processor Connections",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 6,
            "x": 18,
            "y": 29
          },
          "id": 22,
          "description": "Continuous uptime of the stream processor service. Drops to zero indicate crashes or restarts.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "stream_processor_uptime_seconds",
              "legendFormat": "Uptime",
              "refId": "A"
            }
          ],
          "title": "Stream Processor Uptime",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 36
          },
          "id": 23,
          "panels": [],
          "title": "Resource Monitoring",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "decmbytes"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 37
          },
          "id": 24,
          "description": "Working set memory (MB) for core containers: Simulation, Stream Processor, Kafka, Redis. Sourced from cAdvisor via container_memory_working_set_bytes.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (container_memory_working_set_bytes{name=\"rideshare-simulation\"}) / 1024 / 1024",
              "legendFormat": "Simulation",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (container_memory_working_set_bytes{name=\"rideshare-stream-processor\"}) / 1024 / 1024",
              "legendFormat": "Stream Processor",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (container_memory_working_set_bytes{name=\"rideshare-kafka\"}) / 1024 / 1024",
              "legendFormat": "Kafka",
              "refId": "C"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (container_memory_working_set_bytes{name=\"rideshare-redis\"}) / 1024 / 1024",
              "legendFormat": "Redis",
              "refId": "D"
            }
          ],
          "title": "Container Memory Usage",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 37
          },
          "id": 25,
          "description": "CPU utilization (%) for core containers. Calculated from container_cpu_usage_seconds_total rate. Values above 80% may indicate compute bottlenecks.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (rate(container_cpu_usage_seconds_total{name=\"rideshare-simulation\"}[$__rate_interval])) * 100",
              "legendFormat": "Simulation",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (rate(container_cpu_usage_seconds_total{name=\"rideshare-stream-processor\"}[$__rate_interval])) * 100",
              "legendFormat": "Stream Processor",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (rate(container_cpu_usage_seconds_total{name=\"rideshare-kafka\"}[$__rate_interval])) * 100",
              "legendFormat": "Kafka",
              "refId": "C"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "sum by (name) (rate(container_cpu_usage_seconds_total{name=\"rideshare-redis\"}[$__rate_interval])) * 100",
              "legendFormat": "Redis",
              "refId": "D"
            }
          ],
          "title": "Container CPU Usage",
          "type": "timeseries"
        }
      ],
      "refresh": "10s",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["simulation", "rideshare"],
      "templating": {
        "list": [
          {
            "current": {
              "selected": false,
              "text": "Prometheus",
              "value": "prometheus"
            },
            "hide": 0,
            "includeAll": false,
            "label": "Data Source",
            "multi": false,
            "name": "DS_PROMETHEUS",
            "options": [],
            "query": "prometheus",
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "type": "datasource"
          }
        ]
      },
      "time": {
        "from": "now-30m",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Simulation Metrics",
      "uid": "simulation-metrics",
      "version": 1,
      "weekStart": ""
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-data-engineering
  labels:
    app: grafana
data:
  data-quality.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "Silver layer data quality monitoring. Tracks record completeness, null rates, duplicate detection, schema violations, and data type casting failures across staging tables (stg_trips, stg_gps_pings, stg_driver_status). 24-hour lookback via Trino.",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "Quality KPIs",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "description": "Total records ingested into delta.silver.stg_trips in the last 24 hours. Baseline volume metric for quality rate calculations.",
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(*) as total_records\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR",
              "refId": "A"
            }
          ],
          "title": "Total Silver Records (24h)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 2,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 2
                  },
                  {
                    "color": "red",
                    "value": 5
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 1
          },
          "id": 3,
          "description": "Percentage of stg_trips records with null trip_id. Color thresholds: green (<2%), yellow (2-5%), red (5%+). Trip ID is the primary key — nulls indicate broken event linkage.",
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  CAST(SUM(CASE WHEN trip_id IS NULL THEN 1 ELSE 0 END) AS DOUBLE) * 100.0 / COUNT(*) as null_rate\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR",
              "refId": "A"
            }
          ],
          "title": "Null Rate %",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 2,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 0.5
                  },
                  {
                    "color": "red",
                    "value": 1
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 1
          },
          "id": 4,
          "description": "Percentage of duplicate records detected by comparing total count to distinct event_id count. Stricter thresholds: yellow at 0.5%, red at 1%. Duplicates indicate Kafka at-least-once delivery or replay issues.",
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  (COUNT(*) - COUNT(DISTINCT trip_id)) * 100.0 / NULLIF(COUNT(*), 0) as duplicate_rate\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR",
              "refId": "A"
            }
          ],
          "title": "Duplicate Rate %",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 10
                  },
                  {
                    "color": "red",
                    "value": 50
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 1
          },
          "id": 5,
          "description": "Absolute count of records missing required fields (trip_id, timestamp, or event_type). These three fields are mandatory for downstream processing. Yellow at 10, red at 50.",
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(*) as violations\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\n  AND (\n    trip_id IS NULL\n    OR timestamp IS NULL\n    OR event_type IS NULL\n  )",
              "refId": "A"
            }
          ],
          "title": "Schema Violations",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
          },
          "id": 6,
          "panels": [],
          "title": "Completeness Metrics",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "max": 100,
              "min": 0,
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 90
                  },
                  {
                    "color": "green",
                    "value": 98
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 6
          },
          "id": 7,
          "description": "Horizontal bar chart comparing key field completeness (%) across three staging tables. Color scale: red (<90%), yellow (90-98%), green (98%+). Each table checks its primary identifier field.",
          "options": {
            "barRadius": 0.1,
            "barWidth": 0.6,
            "fullHighlight": false,
            "groupWidth": 0.7,
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "orientation": "horizontal",
            "showValue": "always",
            "stacking": "none",
            "tooltip": {
              "mode": "single",
              "sort": "none"
            },
            "xTickLabelRotation": 0
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  'stg_trips' as table_name,\n  CAST(SUM(CASE WHEN trip_id IS NOT NULL THEN 1 ELSE 0 END) AS DOUBLE) * 100.0 / COUNT(*) as completeness\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\nUNION ALL\nSELECT\n  'stg_gps_pings',\n  CAST(SUM(CASE WHEN event_id IS NOT NULL THEN 1 ELSE 0 END) AS DOUBLE) * 100.0 / COUNT(*)\nFROM delta.silver.stg_gps_pings\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\nUNION ALL\nSELECT\n  'stg_driver_status',\n  CAST(SUM(CASE WHEN driver_id IS NOT NULL THEN 1 ELSE 0 END) AS DOUBLE) * 100.0 / COUNT(*)\nFROM delta.silver.stg_driver_status\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\nORDER BY completeness",
              "refId": "A"
            }
          ],
          "title": "Field Completeness by Table",
          "type": "barchart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": []
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 6
          },
          "id": 8,
          "description": "Donut chart showing which fields in stg_trips have the most null values (trip_id, driver_id, fare). Identifies the most problematic fields for targeted quality improvement.",
          "options": {
            "displayLabels": ["name", "percent"],
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "right",
              "showLegend": true,
              "values": ["value"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  'trip_id' as field_name,\n  SUM(CASE WHEN trip_id IS NULL THEN 1 ELSE 0 END) as null_count\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\nUNION ALL\nSELECT\n  'driver_id',\n  SUM(CASE WHEN driver_id IS NULL THEN 1 ELSE 0 END)\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\nUNION ALL\nSELECT\n  'fare',\n  SUM(CASE WHEN fare IS NULL THEN 1 ELSE 0 END)\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR",
              "refId": "A"
            }
          ],
          "title": "Null Fields Distribution",
          "type": "piechart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 13
          },
          "id": 9,
          "panels": [],
          "title": "Quality Trends",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "null_records"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "red",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "total_records"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "blue",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 7,
            "w": 24,
            "x": 0,
            "y": 14
          },
          "id": 10,
          "description": "Hourly time series of total records (blue) vs null records (red). Divergence between the lines indicates quality degradation. Flat null line = healthy ingestion.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  date_trunc('hour', _ingested_at) as time,\n  COUNT(*) as total_records,\n  SUM(CASE WHEN trip_id IS NULL THEN 1 ELSE 0 END) as null_records\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\nGROUP BY date_trunc('hour', _ingested_at)\nORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Record Quality Over Time",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 21
          },
          "id": 11,
          "panels": [],
          "title": "Data Validation",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "custom": {
                "align": "auto",
                "cellOptions": {
                  "type": "auto"
                },
                "inspect": false
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "duration_seconds"
                },
                "properties": [
                  {
                    "id": "custom.cellOptions",
                    "value": {
                      "mode": "basic",
                      "type": "color-background"
                    }
                  },
                  {
                    "id": "thresholds",
                    "value": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "orange",
                          "value": null
                        },
                        {
                          "color": "red",
                          "value": 86400
                        }
                      ]
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "pickup_timestamp"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "dateTimeAsIso"
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "dropoff_timestamp"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "dateTimeAsIso"
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 22
          },
          "id": 12,
          "description": "Detail table of up to 50 records failing validation (null trip_id, null fare, or negative fare). Provides record-level visibility for debugging specific quality issues.",
          "options": {
            "cellHeight": "sm",
            "footer": {
              "countRows": true,
              "fields": "",
              "reducer": ["count"],
              "show": true
            },
            "showHeader": true,
            "sortBy": [
              {
                "desc": true,
                "displayName": "duration_seconds"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  event_id,\n  trip_id,\n  event_type,\n  trip_state,\n  timestamp,\n  fare\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\n  AND (\n    trip_id IS NULL\n    OR fare IS NULL\n    OR fare < 0\n  )\nORDER BY _ingested_at DESC\nLIMIT 50",
              "refId": "A"
            }
          ],
          "title": "Invalid Trip Records",
          "type": "table"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 5
                  },
                  {
                    "color": "red",
                    "value": 20
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 22
          },
          "id": 13,
          "description": "Count of records where fare or surge_multiplier cannot be cast to DOUBLE. Indicates upstream schema drift or serialization errors. Yellow at 5, red at 20.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(*) as violations\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\n  AND (\n    TRY_CAST(fare AS DOUBLE) IS NULL\n    OR TRY_CAST(surge_multiplier AS DOUBLE) IS NULL\n  )",
              "refId": "A"
            }
          ],
          "title": "Data Type Violations",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 29
          },
          "id": 14,
          "panels": [],
          "title": "Cleanliness Metrics",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 24,
            "x": 0,
            "y": 30
          },
          "id": 15,
          "description": "Bar chart breaking down duplicates by event type. Reveals if duplication is concentrated in specific trip lifecycle events (e.g., GPS pings vs trip state changes).",
          "options": {
            "barRadius": 0.1,
            "barWidth": 0.6,
            "fullHighlight": false,
            "groupWidth": 0.7,
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "orientation": "vertical",
            "showValue": "always",
            "stacking": "none",
            "tooltip": {
              "mode": "single",
              "sort": "none"
            },
            "xTickLabelRotation": 0
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  event_type,\n  COUNT(*) - COUNT(DISTINCT event_id) as duplicate_count\nFROM delta.silver.stg_trips\nWHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR\nGROUP BY event_type\nORDER BY duplicate_count DESC",
              "refId": "A"
            }
          ],
          "title": "Duplicate Records by Event Type",
          "type": "barchart"
        }
      ],
      "refresh": "5m",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["silver", "data-engineering", "quality"],
      "templating": {
        "list": [
          {
            "current": {
              "selected": false,
              "text": "Trino",
              "value": "trino"
            },
            "hide": 0,
            "includeAll": false,
            "label": "Data Source",
            "multi": false,
            "name": "DS_TRINO",
            "options": [],
            "query": "trino-datasource",
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "type": "datasource"
          }
        ]
      },
      "time": {
        "from": "now-24h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Data Quality Monitoring",
      "uid": "data-quality-monitoring",
      "version": 1,
      "weekStart": ""
    }
  data-ingestion.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "Bronze layer ingestion pipeline monitoring. Tracks event volume across 6 data sources, dead letter queue (DLQ) error rates, ingestion delays, data freshness per table, and detailed error analysis. 24-hour lookback via Trino against Bronze Delta Lake tables.",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "KPI Metrics",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Combined event count from all 6 Bronze tables (trips, gps_pings, driver_status, surge_updates, ratings, payments). Overall pipeline throughput indicator.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT (SELECT COUNT(*) FROM delta.bronze.bronze_trips WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) + (SELECT COUNT(*) FROM delta.bronze.bronze_gps_pings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) + (SELECT COUNT(*) FROM delta.bronze.bronze_driver_status WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) + (SELECT COUNT(*) FROM delta.bronze.bronze_surge_updates WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) + (SELECT COUNT(*) FROM delta.bronze.bronze_ratings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) + (SELECT COUNT(*) FROM delta.bronze.bronze_payments WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) as total_events",
              "refId": "A"
            }
          ],
          "title": "Total Events (24h)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Count of records routed to Dead Letter Queue tables due to processing failures. Yellow at 10 errors, red at 50. DLQ captures events that failed validation, parsing, or schema checks.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 10
                  },
                  {
                    "color": "red",
                    "value": 50
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 1
          },
          "id": 3,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(*) as error_count FROM (SELECT _ingestion_date FROM delta.bronze.dlq_bronze_trips WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingestion_date FROM delta.bronze.dlq_bronze_gps_pings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingestion_date FROM delta.bronze.dlq_bronze_driver_status WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingestion_date FROM delta.bronze.dlq_bronze_payments WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingestion_date FROM delta.bronze.dlq_bronze_ratings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) dlq",
              "refId": "A"
            }
          ],
          "title": "DLQ Errors (24h)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Maximum time gap between event occurrence and Bronze layer ingestion for trip events. Yellow at 300s (5 min), red at 600s (10 min). Indicates pipeline lag.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 1,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 300
                  },
                  {
                    "color": "red",
                    "value": 600
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 1
          },
          "id": 4,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT MAX(to_unixtime(CAST(_ingested_at AS TIMESTAMP)) - to_unixtime(CAST(_kafka_timestamp AS TIMESTAMP))) as max_delay_seconds\nFROM delta.bronze.bronze_trips\nWHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')",
              "refId": "A"
            }
          ],
          "title": "Max Ingestion Delay (s)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Number of the 6 data source types that have ingested records in the last 24 hours. Expected value is 6 when all sources are active. Values below 6 indicate silent source failures.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 1
          },
          "id": 5,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(*) as active_sources FROM (SELECT 'trips' as source FROM delta.bronze.bronze_trips WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION SELECT 'gps_pings' FROM delta.bronze.bronze_gps_pings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION SELECT 'driver_status' FROM delta.bronze.bronze_driver_status WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION SELECT 'surge_updates' FROM delta.bronze.bronze_surge_updates WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION SELECT 'ratings' FROM delta.bronze.bronze_ratings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION SELECT 'payments' FROM delta.bronze.bronze_payments WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) sources",
              "refId": "A"
            }
          ],
          "title": "Active Sources",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
          },
          "id": 6,
          "panels": [],
          "title": "Volume Distribution",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Donut chart showing relative event volume across the 6 data sources. GPS pings typically dominate due to high-frequency driver location updates.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 6
          },
          "id": 7,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["value", "percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT 'trips' as source, COUNT(*) as event_count FROM delta.bronze.bronze_trips WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT 'gps_pings', COUNT(*) FROM delta.bronze.bronze_gps_pings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT 'driver_status', COUNT(*) FROM delta.bronze.bronze_driver_status WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT 'surge_updates', COUNT(*) FROM delta.bronze.bronze_surge_updates WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT 'ratings', COUNT(*) FROM delta.bronze.bronze_ratings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT 'payments', COUNT(*) FROM delta.bronze.bronze_payments WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') ORDER BY event_count DESC",
              "refId": "A"
            }
          ],
          "title": "Volume by Data Source",
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Distribution of DLQ errors by error classification (validation, parsing, schema mismatch, etc.). Identifies the dominant failure mode for targeted pipeline fixes.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 6
          },
          "id": 8,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["value", "percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT error_type, COUNT(*) as error_count FROM (SELECT error_type FROM delta.bronze.dlq_bronze_trips WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT error_type FROM delta.bronze.dlq_bronze_gps_pings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT error_type FROM delta.bronze.dlq_bronze_driver_status WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT error_type FROM delta.bronze.dlq_bronze_payments WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT error_type FROM delta.bronze.dlq_bronze_ratings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) dlq GROUP BY error_type ORDER BY error_count DESC",
              "refId": "A"
            }
          ],
          "title": "DLQ Errors by Type",
          "type": "piechart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 14
          },
          "id": 9,
          "panels": [],
          "title": "Time Series Trends",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Hourly ingestion rate for the top 3 data sources (trips, gps_pings, driver_status). Shows throughput trends and identifies ingestion gaps or spikes.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Events",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 15
          },
          "id": 10,
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT date_trunc('hour', _ingested_at) as time, 'trips' as source, COUNT(*) as events FROM delta.bronze.bronze_trips WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR GROUP BY date_trunc('hour', _ingested_at) UNION ALL SELECT date_trunc('hour', _ingested_at), 'gps_pings', COUNT(*) FROM delta.bronze.bronze_gps_pings WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR GROUP BY date_trunc('hour', _ingested_at) UNION ALL SELECT date_trunc('hour', _ingested_at), 'driver_status', COUNT(*) FROM delta.bronze.bronze_driver_status WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR GROUP BY date_trunc('hour', _ingested_at) ORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Ingestion Rate Over Time",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 23
          },
          "id": 11,
          "panels": [],
          "title": "Distribution & Freshness",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Daily event volume for the trips table over the past 7 days. Provides a weekly view of ingestion consistency and volume trends.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Events",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "bars",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 24
          },
          "id": 12,
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  _ingestion_date,\n  COUNT(*) as event_count\nFROM delta.bronze.bronze_trips\nWHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '7' DAY, 'yyyy-MM-dd')\nGROUP BY _ingestion_date\nORDER BY _ingestion_date",
              "refId": "A"
            }
          ],
          "title": "Events by Ingestion Date",
          "type": "barchart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Table showing the most recent ingestion timestamp for each of 8 Bronze tables. Stale timestamps (hours old) indicate ingestion pipeline failures for that source.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "custom": {
                "align": "auto",
                "displayMode": "auto",
                "inspect": true
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "last_ingestion"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "dateTimeAsIso"
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 24
          },
          "id": 13,
          "options": {
            "showHeader": true,
            "cellHeight": "sm",
            "footer": {
              "show": false,
              "reducer": ["sum"],
              "fields": ""
            },
            "sortBy": [
              {
                "desc": true,
                "displayName": "last_ingestion"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT 'bronze_trips' as table_name, MAX(_ingested_at) as last_ingestion FROM delta.bronze.bronze_trips UNION ALL SELECT 'bronze_gps_pings', MAX(_ingested_at) FROM delta.bronze.bronze_gps_pings UNION ALL SELECT 'bronze_driver_status', MAX(_ingested_at) FROM delta.bronze.bronze_driver_status UNION ALL SELECT 'bronze_surge_updates', MAX(_ingested_at) FROM delta.bronze.bronze_surge_updates UNION ALL SELECT 'bronze_ratings', MAX(_ingested_at) FROM delta.bronze.bronze_ratings UNION ALL SELECT 'bronze_payments', MAX(_ingested_at) FROM delta.bronze.bronze_payments UNION ALL SELECT 'bronze_driver_profiles', MAX(_ingested_at) FROM delta.bronze.bronze_driver_profiles UNION ALL SELECT 'bronze_rider_profiles', MAX(_ingested_at) FROM delta.bronze.bronze_rider_profiles ORDER BY last_ingestion DESC",
              "refId": "A"
            }
          ],
          "title": "Data Freshness by Table",
          "type": "table"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 32
          },
          "id": 14,
          "panels": [],
          "title": "Error Analysis",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Hourly DLQ error count with a red threshold line at 100 errors/hour. Shows error patterns over time — sustained high rates may indicate systemic issues.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Errors",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "line+area"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "transparent",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 100
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 33
          },
          "id": 15,
          "options": {
            "legend": {
              "calcs": ["mean", "max", "sum"],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT date_trunc('hour', _ingested_at) as time, COUNT(*) as error_count FROM (SELECT _ingested_at FROM delta.bronze.dlq_bronze_trips WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR UNION ALL SELECT _ingested_at FROM delta.bronze.dlq_bronze_gps_pings WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR UNION ALL SELECT _ingested_at FROM delta.bronze.dlq_bronze_driver_status WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR UNION ALL SELECT _ingested_at FROM delta.bronze.dlq_bronze_payments WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR UNION ALL SELECT _ingested_at FROM delta.bronze.dlq_bronze_ratings WHERE _ingested_at >= current_timestamp - INTERVAL '24' HOUR) dlq GROUP BY date_trunc('hour', _ingested_at) ORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Error Rate Trend",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "description": "Detail table of the 50 most recent DLQ records with timestamp, source topic, error type, and error message. Primary debugging tool for pipeline failures.",
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "custom": {
                "align": "auto",
                "displayMode": "auto",
                "inspect": true
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "time"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "dateTimeAsIso"
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "error_message"
                },
                "properties": [
                  {
                    "id": "custom.width",
                    "value": 400
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 33
          },
          "id": 16,
          "options": {
            "showHeader": true,
            "cellHeight": "sm",
            "footer": {
              "show": false,
              "reducer": ["sum"],
              "fields": ""
            },
            "sortBy": [
              {
                "desc": true,
                "displayName": "time"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT _ingested_at as time, kafka_topic as source, error_type, error_message FROM (SELECT _ingested_at, kafka_topic, error_type, error_message FROM delta.bronze.dlq_bronze_trips WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingested_at, kafka_topic, error_type, error_message FROM delta.bronze.dlq_bronze_gps_pings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingested_at, kafka_topic, error_type, error_message FROM delta.bronze.dlq_bronze_driver_status WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingested_at, kafka_topic, error_type, error_message FROM delta.bronze.dlq_bronze_payments WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd') UNION ALL SELECT _ingested_at, kafka_topic, error_type, error_message FROM delta.bronze.dlq_bronze_ratings WHERE _ingestion_date >= format_datetime(current_timestamp - INTERVAL '24' HOUR, 'yyyy-MM-dd')) dlq ORDER BY _ingested_at DESC LIMIT 50",
              "refId": "A"
            }
          ],
          "title": "Recent DLQ Errors",
          "type": "table"
        }
      ],
      "refresh": "5m",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["bronze", "data-engineering", "ingestion"],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-24h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Data Ingestion Monitoring",
      "uid": "data-ingestion-monitoring",
      "version": 1,
      "weekStart": ""
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-business-intelligence
  labels:
    app: grafana
data:
  demand-analysis.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "Rider demand patterns and service quality analysis from the Gold layer. Covers trip request volume, wait time trends, completion rates, trip state distribution, peak/off-peak analysis, and top pickup zones across São Paulo. 7-day lookback via Trino.",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "Demand KPIs",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "description": "Total count of trip requests (all states, not just completed). Represents raw demand volume regardless of outcome.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(*) as total_requests\nFROM delta.gold.fact_trips\nWHERE requested_at >= current_timestamp - INTERVAL '7' DAY",
              "refId": "A"
            }
          ],
          "title": "Total Trips Requested (7d)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 1,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 300
                  },
                  {
                    "color": "red",
                    "value": 600
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 1
          },
          "id": 3,
          "description": "Mean time from trip request to driver match (requested_at to matched_at). Color thresholds: green (<300 sec), yellow (300-600 sec), red (600+ sec). Excludes unmatched trips.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT AVG(date_diff('second', requested_at, matched_at)) as avg_wait\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND matched_at IS NOT NULL",
              "refId": "A"
            }
          ],
          "title": "Average Wait Time",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 1,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 80
                  },
                  {
                    "color": "green",
                    "value": 90
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 1
          },
          "id": 4,
          "description": "Percentage of requested trips that reached COMPLETED state. Color thresholds: red (<80%), yellow (80-90%), green (90%+). Includes cancellations and abandonments in the denominator.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  CAST(SUM(CASE WHEN trip_state = 'completed' THEN 1 ELSE 0 END) AS DOUBLE) * 100.0 / COUNT(*) as completion_rate\nFROM delta.gold.fact_trips\nWHERE requested_at >= current_timestamp - INTERVAL '7' DAY",
              "refId": "A"
            }
          ],
          "title": "Completion Rate %",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "purple",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 1
          },
          "id": 5,
          "description": "Count of distinct riders who requested at least one trip. Measures platform reach and rider engagement.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(DISTINCT rider_key) as unique_riders\nFROM delta.gold.fact_trips\nWHERE requested_at >= current_timestamp - INTERVAL '7' DAY",
              "refId": "A"
            }
          ],
          "title": "Unique Riders (7d)",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
          },
          "id": 6,
          "panels": [],
          "title": "Demand Patterns",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Trips",
                "axisPlacement": "auto",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineWidth": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 6
          },
          "id": 7,
          "description": "Trip request distribution across 24 hours, aggregated over the week. Identifies peak demand hours (typically morning and evening commute).",
          "options": {
            "barRadius": 0.1,
            "barWidth": 0.8,
            "groupWidth": 0.7,
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "orientation": "vertical",
            "showValue": "auto",
            "stacking": "none",
            "tooltip": {
              "mode": "single",
              "sort": "none"
            },
            "xTickLabelRotation": 0
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "WITH hours AS (\n  SELECT hour_val, LPAD(CAST(hour_val AS VARCHAR), 2, '0') || ':00' as hour_label\n  FROM UNNEST(ARRAY[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]) AS t(hour_val)\n),\ntrip_data AS (\n  SELECT hour(requested_at) as hour_val, COUNT(*) as trip_count\n  FROM delta.gold.fact_trips\n  WHERE requested_at >= current_timestamp - INTERVAL '7' DAY\n  GROUP BY hour(requested_at)\n)\nSELECT h.hour_label as hour_of_day, COALESCE(t.trip_count, 0) as trip_count\nFROM hours h LEFT JOIN trip_data t ON h.hour_val = t.hour_val\nORDER BY h.hour_val",
              "refId": "A"
            }
          ],
          "title": "Demand by Hour of Day",
          "type": "barchart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Trips",
                "axisPlacement": "auto",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineWidth": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 6
          },
          "id": 8,
          "description": "Trip request distribution across Monday-Sunday. Reveals weekly demand seasonality (weekday commute vs weekend leisure patterns).",
          "options": {
            "barRadius": 0.1,
            "barWidth": 0.8,
            "groupWidth": 0.7,
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "orientation": "vertical",
            "showValue": "auto",
            "stacking": "none",
            "tooltip": {
              "mode": "single",
              "sort": "none"
            },
            "xTickLabelRotation": 0
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "WITH all_days AS (\n  SELECT day_num, day_name\n  FROM UNNEST(ARRAY[1,2,3,4,5,6,7],\n              ARRAY['Monday','Tuesday','Wednesday','Thursday','Friday','Saturday','Sunday']) AS t(day_num, day_name)\n),\ntrip_data AS (\n  SELECT day_of_week(requested_at) as day_num, COUNT(*) as trip_count\n  FROM delta.gold.fact_trips\n  WHERE requested_at >= current_timestamp - INTERVAL '7' DAY\n  GROUP BY day_of_week(requested_at)\n)\nSELECT d.day_name, COALESCE(t.trip_count, 0) as trip_count\nFROM all_days d LEFT JOIN trip_data t ON d.day_num = t.day_num\nORDER BY d.day_num",
              "refId": "A"
            }
          ],
          "title": "Demand by Day of Week",
          "type": "barchart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 14
          },
          "id": 9,
          "panels": [],
          "title": "Wait Time Analysis",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Seconds",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 10,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "s"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "max_wait"
                },
                "properties": [
                  {
                    "id": "custom.lineStyle",
                    "value": {
                      "fill": "dash",
                      "dash": [10, 10]
                    }
                  },
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "red",
                      "mode": "fixed"
                    }
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "p95_wait"
                },
                "properties": [
                  {
                    "id": "color",
                    "value": {
                      "fixedColor": "orange",
                      "mode": "fixed"
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 15
          },
          "id": 10,
          "description": "Hourly wait time statistics: average, maximum, and p95. Max wait (red dashed) shows worst-case rider experience. p95 (orange) shows the typical tail latency.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  date_trunc('hour', requested_at) as time,\n  AVG(date_diff('second', requested_at, matched_at)) as avg_wait,\n  MAX(date_diff('second', requested_at, matched_at)) as max_wait,\n  APPROX_PERCENTILE(date_diff('second', requested_at, matched_at), 0.95) as p95_wait\nFROM delta.gold.fact_trips\nWHERE requested_at >= current_timestamp - INTERVAL '7' DAY\n  AND matched_at IS NOT NULL\nGROUP BY date_trunc('hour', requested_at)\nORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Wait Time Trend",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 23
          },
          "id": 11,
          "panels": [],
          "title": "Trip Distribution",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Trips",
                "axisPlacement": "auto",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineWidth": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 24
          },
          "id": 12,
          "description": "Histogram of trips bucketed by wait time (0-2, 2-5, 5-10, 10-15, 15+ minutes). Shows what percentage of riders experience acceptable vs. poor wait times.",
          "options": {
            "barRadius": 0.1,
            "barWidth": 0.8,
            "groupWidth": 0.7,
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "orientation": "vertical",
            "showValue": "auto",
            "stacking": "none",
            "tooltip": {
              "mode": "single",
              "sort": "none"
            },
            "xTickLabelRotation": 0
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "WITH buckets AS (\n  SELECT bucket_name, bucket_order\n  FROM UNNEST(ARRAY['0-2 min','2-5 min','5-10 min','10-15 min','15+ min'],\n              ARRAY[1,2,3,4,5]) AS t(bucket_name, bucket_order)\n),\ntrip_data AS (\n  SELECT\n    CASE\n      WHEN date_diff('minute', requested_at, matched_at) < 2 THEN '0-2 min'\n      WHEN date_diff('minute', requested_at, matched_at) < 5 THEN '2-5 min'\n      WHEN date_diff('minute', requested_at, matched_at) < 10 THEN '5-10 min'\n      WHEN date_diff('minute', requested_at, matched_at) < 15 THEN '10-15 min'\n      ELSE '15+ min'\n    END as bucket_name,\n    COUNT(*) as trip_count\n  FROM delta.gold.fact_trips\n  WHERE requested_at >= current_timestamp - INTERVAL '7' DAY AND matched_at IS NOT NULL\n  GROUP BY 1\n)\nSELECT b.bucket_name as wait_bucket, COALESCE(t.trip_count, 0) as trip_count\nFROM buckets b LEFT JOIN trip_data t ON b.bucket_name = t.bucket_name\nORDER BY b.bucket_order",
              "refId": "A"
            }
          ],
          "title": "Wait Time Distribution",
          "type": "barchart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 24
          },
          "id": 13,
          "description": "Donut chart of all trips by final state (completed, cancelled, etc.). Shows the overall trip lifecycle outcome distribution.",
          "options": {
            "displayLabels": ["percent"],
            "legend": {
              "calcs": ["sum"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "/^trip_count$/",
              "values": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT 'completed' as trip_state, COUNT(*) as trip_count\nFROM delta.gold.fact_trips\nWHERE requested_at >= current_timestamp - INTERVAL '7' DAY\nUNION ALL\nSELECT 'cancelled' as trip_state, COUNT(*) as trip_count\nFROM delta.gold.fact_cancellations\nWHERE requested_at >= current_timestamp - INTERVAL '7' DAY",
              "refId": "A"
            }
          ],
          "title": "Trip Status Distribution",
          "type": "piechart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 32
          },
          "id": 14,
          "panels": [],
          "title": "Demand Insights",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "custom": {
                "align": "auto",
                "displayMode": "auto",
                "inspect": true
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "trip_count"
                },
                "properties": [
                  {
                    "id": "custom.displayMode",
                    "value": "gradient-gauge"
                  },
                  {
                    "id": "custom.width",
                    "value": 200
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_wait"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "min"
                  },
                  {
                    "id": "decimals",
                    "value": 1
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "completion_rate"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "percent"
                  },
                  {
                    "id": "decimals",
                    "value": 1
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 33
          },
          "id": 15,
          "description": "Top 20 São Paulo zones ranked by trip request volume, with average wait time and completion rate per zone. Gradient gauge on trip count for visual comparison.",
          "options": {
            "showHeader": true,
            "cellHeight": "sm",
            "footer": {
              "show": false,
              "reducer": ["sum"],
              "fields": ""
            },
            "sortBy": [
              {
                "desc": true,
                "displayName": "trip_count"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  z.name as pickup_zone,\n  COUNT(*) as trip_count,\n  AVG(date_diff('minute', t.requested_at, t.matched_at)) as avg_wait,\n  CAST(SUM(CASE WHEN t.trip_state = 'completed' THEN 1 ELSE 0 END) AS DOUBLE) * 100.0 / COUNT(*) as completion_rate\nFROM delta.gold.fact_trips t\nJOIN delta.gold.dim_zones z ON t.pickup_zone_key = z.zone_key\nWHERE t.requested_at >= current_timestamp - INTERVAL '7' DAY\nGROUP BY z.name\nORDER BY trip_count DESC\nLIMIT 20",
              "refId": "A"
            }
          ],
          "title": "Top Pickup Zones by Demand",
          "type": "table"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineWidth": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_wait"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "min"
                  },
                  {
                    "id": "custom.axisPlacement",
                    "value": "right"
                  },
                  {
                    "id": "custom.fillOpacity",
                    "value": 0
                  },
                  {
                    "id": "custom.drawStyle",
                    "value": "line"
                  },
                  {
                    "id": "custom.lineWidth",
                    "value": 2
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 33
          },
          "id": 16,
          "description": "Comparison of trip volume and wait times across three periods: Morning Peak (7-9 AM), Evening Peak (5-7 PM), and Off-Peak. Dual-axis: bars for trips, line for wait time.",
          "options": {
            "barRadius": 0.1,
            "barWidth": 0.8,
            "groupWidth": 0.7,
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "orientation": "vertical",
            "showValue": "auto",
            "stacking": "none",
            "tooltip": {
              "mode": "multi",
              "sort": "none"
            },
            "xTickLabelRotation": 0
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  CASE\n    WHEN hour(requested_at) BETWEEN 7 AND 9 THEN 'Morning Peak (7-9)'\n    WHEN hour(requested_at) BETWEEN 17 AND 19 THEN 'Evening Peak (17-19)'\n    ELSE 'Off-Peak'\n  END as time_period,\n  COUNT(*) as trip_count,\n  AVG(date_diff('minute', requested_at, matched_at)) as avg_wait\nFROM delta.gold.fact_trips\nWHERE requested_at >= current_timestamp - INTERVAL '7' DAY\nGROUP BY\n  CASE\n    WHEN hour(requested_at) BETWEEN 7 AND 9 THEN 'Morning Peak (7-9)'\n    WHEN hour(requested_at) BETWEEN 17 AND 19 THEN 'Evening Peak (17-19)'\n    ELSE 'Off-Peak'\n  END\nORDER BY\n  CASE time_period\n    WHEN 'Morning Peak (7-9)' THEN 1\n    WHEN 'Evening Peak (17-19)' THEN 2\n    ELSE 3\n  END",
              "refId": "A"
            }
          ],
          "title": "Peak vs Off-Peak Demand",
          "type": "barchart"
        }
      ],
      "refresh": "5m",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["business-intelligence", "demand", "riders", "gold"],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-7d",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Demand Analysis",
      "uid": "demand-analysis",
      "version": 1,
      "weekStart": ""
    }
  driver-performance.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "Driver KPIs",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 8,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "description": "Count of distinct drivers who completed at least one trip. Measures active workforce size (excludes inactive/offline-only drivers).",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(DISTINCT driver_key) as active_drivers\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '7' DAY",
              "refId": "A"
            }
          ],
          "title": "Total Active Drivers (7d)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 1,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 4.0
                  },
                  {
                    "color": "green",
                    "value": 4.5
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 8,
            "x": 8,
            "y": 1
          },
          "id": 3,
          "description": "Mean driver rating from the fact_ratings table (ratee_type = 'driver'). Color thresholds: red (<4.0), yellow (4.0-4.5), green (4.5+). Scale is 1-5 stars.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT AVG(r.rating) as avg_rating\nFROM delta.gold.fact_ratings r\nJOIN delta.gold.fact_trips t ON r.trip_key = t.trip_key\nWHERE t.completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND r.ratee_type = 'driver'",
              "refId": "A"
            }
          ],
          "title": "Average Rating",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "decimals": 1,
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 60
                  },
                  {
                    "color": "green",
                    "value": 80
                  }
                ]
              },
              "unit": "percent"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 8,
            "x": 16,
            "y": 1
          },
          "id": 4,
          "description": "Mean idle percentage from agg_daily_driver_performance. Represents ratio of available (non-trip) time to total online time. Color thresholds: green (<20%), yellow (20-40%), red (40%+).",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT AVG(idle_pct) as avg_idle_pct\nFROM delta.gold.agg_daily_driver_performance dp\nJOIN delta.gold.dim_time dt ON dp.time_key = dt.time_key\nWHERE dt.date_key >= current_date - INTERVAL '7' DAY",
              "refId": "A"
            }
          ],
          "title": "Average Idle Time %",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
          },
          "id": 5,
          "panels": [],
          "title": "Performance Distribution",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Trip Count",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "bars",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 6
          },
          "id": 6,
          "description": "Histogram of trip counts by rating bucket (1-5 stars, floored). Shows the shape of the rating distribution — ideally concentrated at 4-5 stars.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "WITH ratings AS (\n  SELECT rating_val, rating_label\n  FROM UNNEST(ARRAY[1,2,3,4,5],\n              ARRAY['1 Star','2 Stars','3 Stars','4 Stars','5 Stars']) AS t(rating_val, rating_label)\n),\nrating_data AS (\n  SELECT CAST(FLOOR(r.rating) AS INTEGER) as rating_val, COUNT(*) as trip_count\n  FROM delta.gold.fact_ratings r\n  JOIN delta.gold.fact_trips t ON r.trip_key = t.trip_key\n  WHERE t.completed_at >= current_timestamp - INTERVAL '7' DAY AND r.ratee_type = 'driver'\n  GROUP BY CAST(FLOOR(r.rating) AS INTEGER)\n)\nSELECT rt.rating_label as rating_bucket, COALESCE(rd.trip_count, 0) as trip_count\nFROM ratings rt LEFT JOIN rating_data rd ON rt.rating_val = rd.rating_val\nORDER BY rt.rating_val",
              "refId": "A"
            }
          ],
          "title": "Driver Rating Distribution",
          "type": "barchart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 6
          },
          "id": 7,
          "description": "Donut chart segmenting drivers into High (50%+), Medium (20-50%), and Low (<20%) utilization tiers. Shows workforce efficiency distribution.",
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["value", "percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  CASE\n    WHEN dp.idle_pct >= 80 THEN 'High Idle (80%+)'\n    WHEN dp.idle_pct >= 50 THEN 'Moderate Idle (50-80%)'\n    ELSE 'Low Idle (<50%)'\n  END as idle_tier,\n  COUNT(DISTINCT dp.driver_key) as driver_count\nFROM delta.gold.agg_daily_driver_performance dp\nJOIN delta.gold.dim_time dt ON dp.time_key = dt.time_key\nWHERE dt.date_key >= CAST(current_timestamp - INTERVAL '7' DAY AS DATE)\nGROUP BY\n  CASE\n    WHEN dp.idle_pct >= 80 THEN 'High Idle (80%+)'\n    WHEN dp.idle_pct >= 50 THEN 'Moderate Idle (50-80%)'\n    ELSE 'Low Idle (<50%)'\n  END\nORDER BY driver_count DESC",
              "refId": "A"
            }
          ],
          "title": "Driver Idle Time Breakdown",
          "type": "piechart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 14
          },
          "id": 8,
          "panels": [],
          "title": "Performance Trends",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_rating"
                },
                "properties": [
                  {
                    "id": "displayName",
                    "value": "Driver Rating (1-5)"
                  },
                  {
                    "id": "custom.axisLabel",
                    "value": "Rating (0-5)"
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "idle_rate"
                },
                "properties": [
                  {
                    "id": "displayName",
                    "value": "Idle Rate (%)"
                  },
                  {
                    "id": "unit",
                    "value": "percentunit"
                  },
                  {
                    "id": "custom.axisPlacement",
                    "value": "right"
                  },
                  {
                    "id": "custom.axisLabel",
                    "value": "Idle Rate"
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_on_trip_minutes"
                },
                "properties": [
                  {
                    "id": "displayName",
                    "value": "On-Trip Time (min)"
                  },
                  {
                    "id": "unit",
                    "value": "m"
                  },
                  {
                    "id": "custom.axisPlacement",
                    "value": "right"
                  },
                  {
                    "id": "custom.axisLabel",
                    "value": "On-Trip Minutes"
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 15
          },
          "id": 9,
          "description": "Three daily metrics overlaid: average rating (left axis, 0-5), idle rate (right axis, %), and average on-trip minutes (right axis). Shows correlation between performance dimensions.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  CAST(dt.date_key AS TIMESTAMP) as time,\n  AVG(dp.avg_rating) as avg_rating,\n  AVG(dp.idle_pct) / 100.0 as idle_rate,\n  AVG(dp.on_trip_minutes) as avg_on_trip_minutes\nFROM delta.gold.agg_daily_driver_performance dp\nJOIN delta.gold.dim_time dt ON dp.time_key = dt.time_key\nWHERE dt.date_key >= CAST(current_timestamp - INTERVAL '7' DAY AS DATE)\nGROUP BY dt.date_key\nORDER BY dt.date_key",
              "refId": "A"
            }
          ],
          "title": "Daily Performance Metrics",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 23
          },
          "id": 10,
          "panels": [],
          "title": "Top Performers",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "custom": {
                "align": "auto",
                "displayMode": "auto",
                "inspect": true
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_rating"
                },
                "properties": [
                  {
                    "id": "decimals",
                    "value": 2
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "total_earnings"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "currencyUSD"
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 24
          },
          "id": 11,
          "description": "Top 20 drivers ranked by completed trip count, with average rating and total earnings. Identifies the most active and productive drivers.",
          "options": {
            "showHeader": true,
            "cellHeight": "sm",
            "footer": {
              "show": false,
              "reducer": ["sum"],
              "fields": ""
            },
            "sortBy": [
              {
                "desc": true,
                "displayName": "total_trips"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  d.driver_id,\n  d.first_name || ' ' || d.last_name as driver_name,\n  COUNT(t.trip_key) as total_trips,\n  AVG(r.rating) as avg_rating,\n  CAST(SUM(t.fare) AS DECIMAL(10,2)) as total_earnings\nFROM delta.gold.dim_drivers d\nJOIN delta.gold.fact_trips t ON d.driver_key = t.driver_key\nLEFT JOIN delta.gold.fact_ratings r ON t.trip_key = r.trip_key AND r.ratee_type = 'driver'\nWHERE t.completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND t.trip_state = 'completed'\nGROUP BY d.driver_id, d.first_name, d.last_name\nORDER BY total_trips DESC\nLIMIT 20",
              "refId": "A"
            }
          ],
          "title": "Top Drivers by Trips (7d)",
          "type": "table"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "custom": {
                "align": "auto",
                "displayMode": "auto",
                "inspect": true
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "total_payout"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "currencyUSD"
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_rating"
                },
                "properties": [
                  {
                    "id": "decimals",
                    "value": 1
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 24
          },
          "id": 12,
          "description": "Scatter plot of trips completed vs total payout for up to 100 drivers. Reveals the relationship between activity volume and compensation. Outliers may indicate high-surge or long-distance specialists.",
          "options": {
            "showHeader": true,
            "cellHeight": "sm",
            "footer": {"show": false, "reducer": ["sum"], "fields": ""},
            "sortBy": [{"desc": true, "displayName": "trips_completed"}]
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  d.driver_id,\n  dp.trips_completed,\n  dp.total_payout,\n  dp.avg_rating\nFROM delta.gold.agg_daily_driver_performance dp\nJOIN delta.gold.dim_drivers d ON dp.driver_key = d.driver_key\nJOIN delta.gold.dim_time dt ON dp.time_key = dt.time_key\nWHERE dt.date_key >= CAST(current_timestamp - INTERVAL '7' DAY AS DATE)\n  AND dp.trips_completed > 0\nORDER BY dp.trips_completed DESC\nLIMIT 100",
              "refId": "A"
            }
          ],
          "title": "Driver Trips vs Earnings",
          "type": "table"
        }
      ],
      "refresh": "5m",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["business-intelligence", "drivers", "gold"],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-7d",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Driver Performance",
      "description": "Driver workforce analytics from the Gold layer. Monitors active driver count, ratings, utilization efficiency, performance trends, and individual driver rankings. 7-day lookback via Trino against agg_daily_driver_performance and related Gold tables.",
      "uid": "driver-performance",
      "version": 1,
      "weekStart": ""
    }
  revenue-analytics.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "Revenue analysis across the rideshare platform's Gold layer. Tracks total revenue, fare distribution, payment methods, platform fees, and top-earning drivers. All data queried from Delta Lake Gold tables via Trino with a 7-day lookback window.",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "Revenue KPIs",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "currencyUSD",
              "decimals": 0
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 1
          },
          "id": 2,
          "description": "Sum of all fares from completed trips in the last 7 days. Queried from delta.gold.fact_trips where trip_state = 'completed'.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT SUM(fare) as total_revenue\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND trip_state = 'completed'",
              "refId": "A"
            }
          ],
          "title": "Total Revenue (7d)",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  }
                ]
              },
              "unit": "currencyUSD",
              "decimals": 2
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 1
          },
          "id": 3,
          "description": "Mean fare amount across completed trips with positive fares. Excludes zero-fare trips to avoid skewing the average.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT AVG(fare) as avg_fare\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND trip_state = 'completed'\n  AND fare > 0",
              "refId": "A"
            }
          ],
          "title": "Average Fare",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "purple",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 1
          },
          "id": 4,
          "description": "Count of trips that reached COMPLETED state in the last 7 days. Represents revenue-generating trip volume.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT COUNT(*) as paid_trips\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND trip_state = 'completed'",
              "refId": "A"
            }
          ],
          "title": "Total Trips Paid",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "orange",
                    "value": null
                  }
                ]
              },
              "unit": "currencyUSD",
              "decimals": 2
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 1
          },
          "id": 5,
          "description": "Total revenue divided by trip count (with null-safe division). Equivalent to average fare but computed differently for cross-validation.",
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  SUM(fare) / NULLIF(COUNT(*), 0) as revenue_per_trip\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND trip_state = 'completed'",
              "refId": "A"
            }
          ],
          "title": "Revenue per Trip",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
          },
          "id": 6,
          "panels": [],
          "title": "Revenue Distribution",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 6
          },
          "id": 7,
          "description": "Revenue distribution across payment methods (credit card, cash, wallet, etc.). Sourced from fact_payments joined with fact_trips. Donut chart shows relative share.",
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["value", "percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  p.payment_method_type,\n  SUM(p.total_fare) as total_revenue\nFROM delta.gold.fact_payments p\nJOIN delta.gold.fact_trips t ON p.trip_key = t.trip_key\nWHERE t.completed_at >= current_timestamp - INTERVAL '7' DAY\nGROUP BY p.payment_method_type\nORDER BY total_revenue DESC",
              "refId": "A"
            }
          ],
          "title": "Revenue by Payment Method",
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Trips",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "bars",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 6
          },
          "id": 8,
          "description": "Histogram of trip counts across 5 fare buckets ($0-10, $10-20, $20-30, $30-50, $50+). Shows the pricing distribution shape of the platform.",
          "options": {
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "WITH fare_ranges AS (\n  SELECT range_name, range_order\n  FROM UNNEST(ARRAY['$0-10','$10-20','$20-30','$30-50','$50+'],\n              ARRAY[1,2,3,4,5]) AS t(range_name, range_order)\n),\ntrip_data AS (\n  SELECT\n    CASE\n      WHEN fare < 10 THEN '$0-10'\n      WHEN fare < 20 THEN '$10-20'\n      WHEN fare < 30 THEN '$20-30'\n      WHEN fare < 50 THEN '$30-50'\n      ELSE '$50+'\n    END as fare_bucket,\n    COUNT(*) as trip_count,\n    SUM(fare) as revenue\n  FROM delta.gold.fact_trips\n  WHERE completed_at >= current_timestamp - INTERVAL '7' DAY\n    AND trip_state = 'completed' AND fare > 0\n  GROUP BY 1\n)\nSELECT f.range_name as fare_bucket, COALESCE(t.trip_count, 0) as trip_count, COALESCE(t.revenue, 0) as revenue\nFROM fare_ranges f LEFT JOIN trip_data t ON f.range_name = t.fare_bucket\nORDER BY f.range_order",
              "refId": "A"
            }
          ],
          "title": "Fare Range Distribution",
          "type": "barchart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 14
          },
          "id": 9,
          "panels": [],
          "title": "Revenue Trends",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "currencyUSD"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 15
          },
          "id": 10,
          "description": "Total revenue per day over the last 30 days. Sourced from fact_trips table aggregated by date.",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  CAST(completed_at AS DATE) as time,\n  SUM(fare) as total_revenue\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '30' DAY\n  AND trip_state = 'completed'\nGROUP BY CAST(completed_at AS DATE)\nORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Daily Revenue",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_fare"
                },
                "properties": [
                  {
                    "id": "custom.axisPlacement",
                    "value": "right"
                  },
                  {
                    "id": "custom.lineStyle",
                    "value": {
                      "fill": "dash",
                      "dash": [10, 10]
                    }
                  },
                  {
                    "id": "unit",
                    "value": "currencyUSD"
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "total_trips"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "short"
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 24,
            "x": 0,
            "y": 23
          },
          "id": 18,
          "description": "Daily trip volume and average fare over the last 30 days. Trip count on left axis, average fare on right axis (dashed).",
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "table",
              "placement": "right",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  CAST(completed_at AS DATE) as time,\n  COUNT(*) as total_trips,\n  AVG(fare) as avg_fare\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '30' DAY\n  AND trip_state = 'completed'\nGROUP BY CAST(completed_at AS DATE)\nORDER BY time",
              "refId": "A"
            }
          ],
          "title": "Daily Trip Volume & Avg Fare",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 31
          },
          "id": 11,
          "panels": [],
          "title": "Payment Analysis",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "custom": {
                "align": "auto",
                "displayMode": "auto",
                "inspect": true
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "success_rate"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "percent"
                  },
                  {
                    "id": "decimals",
                    "value": 1
                  },
                  {
                    "id": "custom.displayMode",
                    "value": "color-background"
                  },
                  {
                    "id": "thresholds",
                    "value": {
                      "mode": "absolute",
                      "steps": [
                        {
                          "color": "red",
                          "value": null
                        },
                        {
                          "color": "yellow",
                          "value": 90
                        },
                        {
                          "color": "green",
                          "value": 95
                        }
                      ]
                    }
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 32
          },
          "id": 12,
          "description": "Tabular breakdown of payment statistics per method: transaction count, total amount processed, and average transaction size.",
          "options": {
            "showHeader": true,
            "cellHeight": "sm",
            "footer": {
              "show": false,
              "reducer": ["sum"],
              "fields": ""
            },
            "sortBy": [
              {
                "desc": true,
                "displayName": "success_rate"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  payment_method_type,\n  COUNT(*) as total_payments,\n  SUM(total_fare) as total_amount,\n  AVG(total_fare) as avg_amount\nFROM delta.gold.fact_payments\nWHERE payment_timestamp >= current_timestamp - INTERVAL '7' DAY\nGROUP BY payment_method_type\nORDER BY total_payments DESC",
              "refId": "A"
            }
          ],
          "title": "Payment Breakdown by Method",
          "type": "table"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              }
            },
            "overrides": []
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 32
          },
          "id": 13,
          "description": "Distribution of platform fees collected, grouped by payment method. Platform fees represent the marketplace's revenue margin on each transaction.",
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["value", "percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  payment_method_type,\n  COUNT(*) as payment_count,\n  SUM(platform_fee) as total_platform_fee,\n  AVG(platform_fee) as avg_platform_fee\nFROM delta.gold.fact_payments\nWHERE payment_timestamp >= current_timestamp - INTERVAL '7' DAY\nGROUP BY payment_method_type\nORDER BY total_platform_fee DESC",
              "refId": "A"
            }
          ],
          "title": "Platform Fee by Payment Method",
          "type": "piechart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 40
          },
          "id": 14,
          "panels": [],
          "title": "Profitability Insights",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Revenue ($)",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "bars",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "currencyUSD"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "trip_count"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "short"
                  },
                  {
                    "id": "custom.axisPlacement",
                    "value": "right"
                  },
                  {
                    "id": "custom.axisLabel",
                    "value": "Trip Count"
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 0,
            "y": 41
          },
          "id": 15,
          "description": "Revenue and trip volume by hour (0-23) aggregated across the week. Reveals peak revenue hours. Dual-axis: revenue (left) vs trip count (right).",
          "options": {
            "legend": {
              "calcs": ["sum"],
              "displayMode": "table",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "multi",
              "sort": "desc"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "WITH hours AS (\n  SELECT hour_val, LPAD(CAST(hour_val AS VARCHAR), 2, '0') || ':00' as hour_label\n  FROM UNNEST(ARRAY[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]) AS t(hour_val)\n),\nhourly_data AS (\n  SELECT\n    hour(completed_at) as hour_val,\n    SUM(fare) as total_revenue,\n    COUNT(*) as trip_count,\n    AVG(fare) as avg_fare\n  FROM delta.gold.fact_trips\n  WHERE completed_at >= current_timestamp - INTERVAL '7' DAY\n    AND trip_state = 'completed'\n  GROUP BY hour(completed_at)\n)\nSELECT h.hour_label as hour_of_day, COALESCE(d.total_revenue, 0) as total_revenue, COALESCE(d.trip_count, 0) as trip_count, COALESCE(d.avg_fare, 0) as avg_fare\nFROM hours h LEFT JOIN hourly_data d ON h.hour_val = d.hour_val\nORDER BY h.hour_val",
              "refId": "A"
            }
          ],
          "title": "Revenue by Hour of Day",
          "type": "barchart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "trino"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "custom": {
                "align": "auto",
                "displayMode": "auto",
                "inspect": true
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "total_revenue"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "currencyUSD"
                  },
                  {
                    "id": "decimals",
                    "value": 2
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_fare"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "currencyUSD"
                  },
                  {
                    "id": "decimals",
                    "value": 2
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "total_distance"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "km"
                  },
                  {
                    "id": "decimals",
                    "value": 1
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 8,
            "w": 12,
            "x": 12,
            "y": 41
          },
          "id": 16,
          "description": "Top 20 drivers ranked by total revenue. Includes trip count, average fare, and total distance driven.",
          "options": {
            "showHeader": true,
            "cellHeight": "sm",
            "footer": {
              "show": false,
              "reducer": ["sum"],
              "fields": ""
            },
            "sortBy": [
              {
                "desc": true,
                "displayName": "total_revenue"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "trino"
              },
              "format": 0,
              "rawQuery": true,
              "rawSql": "SELECT\n  d.driver_id,\n  d.first_name || ' ' || d.last_name as driver_name,\n  COUNT(t.trip_key) as total_trips,\n  SUM(t.fare) as total_revenue,\n  AVG(t.fare) as avg_fare,\n  SUM(t.distance_km) as total_distance\nFROM delta.gold.dim_drivers d\nJOIN delta.gold.fact_trips t ON d.driver_key = t.driver_key\nWHERE t.completed_at >= current_timestamp - INTERVAL '7' DAY\n  AND t.trip_state = 'completed'\nGROUP BY d.driver_id, d.first_name, d.last_name\nORDER BY total_revenue DESC\nLIMIT 20",
              "refId": "A"
            }
          ],
          "title": "Top Revenue Drivers (7d)",
          "type": "table"
        }
      ],
      "refresh": "5m",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["business-intelligence", "revenue", "payments", "gold"],
      "templating": {
        "list": []
      },
      "time": {
        "from": "now-7d",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Revenue Analytics",
      "uid": "revenue-analytics",
      "version": 1,
      "weekStart": ""
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards-operations
  labels:
    app: grafana
data:
  platform-operations.json: |
    {
      "annotations": {
        "list": [
          {
            "builtIn": 1,
            "datasource": {
              "type": "grafana",
              "uid": "-- Grafana --"
            },
            "enable": true,
            "hide": true,
            "iconColor": "rgba(0, 211, 255, 1)",
            "name": "Annotations & Alerts",
            "type": "dashboard"
          }
        ]
      },
      "description": "Unified operations dashboard combining real-time Prometheus metrics with historical Gold layer analytics. Monitors live simulation state, system health, trip state distribution, driver activity, and hourly platform utilization. Dual-datasource: Prometheus (real-time) + Trino (historical).",
      "editable": true,
      "fiscalYearStartMonth": 0,
      "graphTooltip": 1,
      "id": null,
      "links": [],
      "liveNow": false,
      "panels": [
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 0
          },
          "id": 1,
          "panels": [],
          "title": "Real-Time Operational KPIs",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "red",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 50
                  },
                  {
                    "color": "green",
                    "value": 100
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 0,
            "y": 1
          },
          "description": "Current driver count from Prometheus (real-time). Color thresholds: red (<50), yellow (50-100), green (100+). Uses operations-specific thresholds.",
          "id": 2,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_drivers_available",
              "legendFormat": "Drivers Available",
              "refId": "A"
            }
          ],
          "title": "Drivers Available",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "blue",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 6,
            "y": 1
          },
          "description": "Current count of trips in non-terminal states. Real-time snapshot from Prometheus simulation_trips_active.",
          "id": 3,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_trips_active",
              "legendFormat": "Active Trips",
              "refId": "A"
            }
          ],
          "title": "Active Trips",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  },
                  {
                    "color": "yellow",
                    "value": 20
                  },
                  {
                    "color": "red",
                    "value": 50
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 12,
            "y": 1
          },
          "description": "Riders currently in vehicles. Color thresholds: yellow at 20, red at 50 (high values may indicate capacity strain).",
          "id": 4,
          "options": {
            "colorMode": "value",
            "graphMode": "area",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_riders_in_transit",
              "legendFormat": "Riders In Transit",
              "refId": "A"
            }
          ],
          "title": "Riders In Transit",
          "type": "stat"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "mappings": [
                {
                  "options": {
                    "match": "null",
                    "result": {
                      "text": "N/A"
                    }
                  },
                  "type": "special"
                }
              ],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "purple",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 4,
            "w": 6,
            "x": 18,
            "y": 1
          },
          "description": "Ride offers awaiting driver acceptance. Displays \"N/A\" when no offers have been created yet. High values indicate matching backlog.",
          "id": 5,
          "options": {
            "colorMode": "value",
            "graphMode": "none",
            "justifyMode": "auto",
            "orientation": "auto",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "textMode": "auto"
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_offers_pending",
              "legendFormat": "Pending Offers",
              "refId": "A"
            }
          ],
          "title": "Pending Offers",
          "type": "stat"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 5
          },
          "id": 6,
          "panels": [],
          "title": "Historical Performance (Gold Layer)",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Trips",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 6
          },
          "description": "Hourly completed trip count from agg_hourly_zone_demand Gold table. Shows historical throughput over the past 24 hours (not real-time).",
          "id": 7,
          "options": {
            "legend": {
              "calcs": ["mean", "last"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 1,
              "rawSql": "SELECT\n  hour_timestamp as time,\n  SUM(completed_trips) as trips_completed\nFROM delta.gold.agg_hourly_zone_demand\nWHERE hour_timestamp >= current_timestamp - INTERVAL '24' HOUR\nGROUP BY hour_timestamp\nORDER BY hour_timestamp",
              "refId": "A"
            }
          ],
          "title": "Trips Completed (24h)",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Minutes",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "smooth",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "auto",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "m"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 6
          },
          "description": "Hourly average wait time (time from trip request to driver arrival) from the zone demand aggregation table. Shows rider wait time trends over the past 24 hours.",
          "id": 8,
          "options": {
            "legend": {
              "calcs": ["mean", "last"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 1,
              "rawSql": "SELECT\n  hour_timestamp as time,\n  AVG(avg_wait_time_minutes) as avg_wait_time_minutes\nFROM delta.gold.agg_hourly_zone_demand\nWHERE hour_timestamp >= current_timestamp - INTERVAL '24' HOUR\nGROUP BY hour_timestamp\nORDER BY hour_timestamp",
              "refId": "A"
            }
          ],
          "title": "Average Wait Time Trend",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 13
          },
          "id": 9,
          "panels": [],
          "title": "System Health",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Events/sec",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 20,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 1,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "ops"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 14
          },
          "description": "5-minute rate of total simulation events per second. Indicates real-time simulation engine throughput. Flat lines may indicate simulation pause or crash.",
          "id": 10,
          "options": {
            "legend": {
              "calcs": ["mean", "last"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "rate(simulation_events_total[5m])",
              "legendFormat": "Events/sec",
              "refId": "A"
            }
          ],
          "title": "Event Processing Rate",
          "type": "timeseries"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "fixedColor": "red",
                "mode": "fixed"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "Errors/sec",
                "axisPlacement": "auto",
                "barAlignment": 0,
                "drawStyle": "line",
                "fillOpacity": 15,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineInterpolation": "linear",
                "lineWidth": 2,
                "pointSize": 5,
                "scaleDistribution": {
                  "type": "linear"
                },
                "showPoints": "never",
                "spanNulls": false,
                "stacking": {
                  "group": "A",
                  "mode": "none"
                },
                "thresholdsStyle": {
                  "mode": "line+area"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "transparent",
                    "value": null
                  },
                  {
                    "color": "red",
                    "value": 10
                  }
                ]
              },
              "unit": "ops"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 14
          },
          "description": "5-minute error rate with a red threshold line at 10 errors/sec. Sustained rates above threshold indicate systemic failures requiring investigation.",
          "id": 11,
          "options": {
            "legend": {
              "calcs": ["mean", "max"],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "rate(simulation_errors_total[5m])",
              "legendFormat": "Errors/sec",
              "refId": "A"
            }
          ],
          "title": "Error Rate",
          "type": "timeseries"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 21
          },
          "id": 12,
          "panels": [],
          "title": "Trip State Distribution",
          "type": "row"
        },
        {
          "datasource": {
            "type": "prometheus",
            "uid": "${DS_PROMETHEUS}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 22
          },
          "description": "Donut chart showing current active trips vs recently completed and cancelled trips (5-minute window). Provides a real-time snapshot of trip lifecycle distribution.",
          "id": 13,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["value", "percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "simulation_trips_active",
              "legendFormat": "Active",
              "refId": "A"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "increase(simulation_trips_completed_total[5m])",
              "legendFormat": "Completed (5m)",
              "refId": "B"
            },
            {
              "datasource": {
                "type": "prometheus",
                "uid": "${DS_PROMETHEUS}"
              },
              "expr": "increase(simulation_trips_cancelled_total[5m])",
              "legendFormat": "Cancelled (5m)",
              "refId": "C"
            }
          ],
          "title": "Trip States (Real-time)",
          "type": "piechart"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": []
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 22
          },
          "description": "Donut chart of all trip outcomes from the Gold layer over 24 hours. Provides historical context for the real-time view in the adjacent panel.",
          "id": 14,
          "options": {
            "legend": {
              "displayMode": "table",
              "placement": "right",
              "showLegend": true,
              "values": ["value", "percent"]
            },
            "pieType": "donut",
            "reduceOptions": {
              "calcs": ["lastNotNull"],
              "fields": "",
              "values": false
            },
            "tooltip": {
              "mode": "single",
              "sort": "none"
            }
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawSql": "SELECT\n  trip_state,\n  COUNT(*) as trip_count\nFROM delta.gold.fact_trips\nWHERE completed_at >= current_timestamp - INTERVAL '24' HOUR\nGROUP BY trip_state\nORDER BY trip_count DESC",
              "refId": "A"
            }
          ],
          "title": "Trip Outcomes (24h)",
          "type": "piechart"
        },
        {
          "collapsed": false,
          "gridPos": {
            "h": 1,
            "w": 24,
            "x": 0,
            "y": 29
          },
          "id": 15,
          "panels": [],
          "title": "Driver & Rider Activity",
          "type": "row"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "thresholds"
              },
              "custom": {
                "align": "auto",
                "cellOptions": {
                  "type": "auto"
                },
                "inspect": false
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              }
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_fare"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "currencyUSD"
                  },
                  {
                    "id": "decimals",
                    "value": 2
                  }
                ]
              },
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_distance"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "km"
                  },
                  {
                    "id": "decimals",
                    "value": 1
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 0,
            "y": 30
          },
          "description": "Top 20 drivers by completed trip count in the last 24 hours with average fare and distance. Operations-focused variant with 24-hour lookback.",
          "id": 16,
          "options": {
            "cellHeight": "sm",
            "footer": {
              "countRows": false,
              "fields": "",
              "reducer": ["sum"],
              "show": false
            },
            "showHeader": true,
            "sortBy": [
              {
                "desc": true,
                "displayName": "total_trips"
              }
            ]
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawSql": "SELECT\n  d.driver_id,\n  d.first_name || ' ' || d.last_name as driver_name,\n  COUNT(t.trip_key) as total_trips,\n  AVG(t.fare) as avg_fare,\n  AVG(t.distance_km) as avg_distance\nFROM delta.gold.fact_trips t\nJOIN delta.gold.dim_drivers d ON t.driver_key = d.driver_key\nWHERE t.completed_at >= current_timestamp - INTERVAL '24' HOUR\nGROUP BY d.driver_id, d.first_name, d.last_name\nORDER BY total_trips DESC\nLIMIT 20",
              "refId": "A"
            }
          ],
          "title": "Top Drivers by Trips (24h)",
          "type": "table"
        },
        {
          "datasource": {
            "type": "trino-datasource",
            "uid": "${DS_TRINO}"
          },
          "fieldConfig": {
            "defaults": {
              "color": {
                "mode": "palette-classic"
              },
              "custom": {
                "axisCenteredZero": false,
                "axisColorMode": "text",
                "axisLabel": "",
                "axisPlacement": "auto",
                "fillOpacity": 80,
                "gradientMode": "none",
                "hideFrom": {
                  "legend": false,
                  "tooltip": false,
                  "viz": false
                },
                "lineWidth": 1,
                "scaleDistribution": {
                  "type": "linear"
                },
                "thresholdsStyle": {
                  "mode": "off"
                }
              },
              "mappings": [],
              "thresholds": {
                "mode": "absolute",
                "steps": [
                  {
                    "color": "green",
                    "value": null
                  }
                ]
              },
              "unit": "short"
            },
            "overrides": [
              {
                "matcher": {
                  "id": "byName",
                  "options": "avg_wait_time_minutes"
                },
                "properties": [
                  {
                    "id": "unit",
                    "value": "m"
                  },
                  {
                    "id": "custom.axisPlacement",
                    "value": "right"
                  }
                ]
              }
            ]
          },
          "gridPos": {
            "h": 7,
            "w": 12,
            "x": 12,
            "y": 30
          },
          "description": "Dual-axis bar chart: completed trips vs average wait time by hour of day. Identifies peak operational hours and corresponding service quality.",
          "id": 17,
          "options": {
            "barRadius": 0.05,
            "barWidth": 0.7,
            "groupWidth": 0.7,
            "legend": {
              "calcs": [],
              "displayMode": "list",
              "placement": "bottom",
              "showLegend": true
            },
            "orientation": "auto",
            "showValue": "auto",
            "stacking": "none",
            "tooltip": {
              "mode": "multi",
              "sort": "none"
            },
            "xTickLabelRotation": 0
          },
          "pluginVersion": "10.0.0",
          "targets": [
            {
              "datasource": {
                "type": "trino-datasource",
                "uid": "${DS_TRINO}"
              },
              "format": 0,
              "rawSql": "WITH hours AS (\n  SELECT hour_val, LPAD(CAST(hour_val AS VARCHAR), 2, '0') || ':00' as hour_label\n  FROM UNNEST(ARRAY[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23]) AS t(hour_val)\n),\nhourly_data AS (\n  SELECT\n    hour(hour_timestamp) as hour_val,\n    SUM(completed_trips) as trips_completed,\n    AVG(avg_wait_time_minutes) as avg_wait_time_minutes\n  FROM delta.gold.agg_hourly_zone_demand\n  WHERE hour_timestamp >= current_timestamp - INTERVAL '24' HOUR\n  GROUP BY hour(hour_timestamp)\n)\nSELECT h.hour_label as hour_of_day, COALESCE(d.trips_completed, 0) as trips_completed, COALESCE(d.avg_wait_time_minutes, 0) as avg_wait_time_minutes\nFROM hours h LEFT JOIN hourly_data d ON h.hour_val = d.hour_val\nORDER BY h.hour_val",
              "refId": "A"
            }
          ],
          "title": "Platform Utilization by Hour",
          "type": "barchart"
        }
      ],
      "refresh": "1m",
      "schemaVersion": 38,
      "style": "dark",
      "tags": ["operations", "gold", "prometheus", "real-time"],
      "templating": {
        "list": [
          {
            "current": {
              "selected": false,
              "text": "Prometheus",
              "value": "prometheus"
            },
            "hide": 0,
            "includeAll": false,
            "label": "Prometheus",
            "multi": false,
            "name": "DS_PROMETHEUS",
            "options": [],
            "query": "prometheus",
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "type": "datasource"
          },
          {
            "current": {
              "selected": false,
              "text": "Trino",
              "value": "trino"
            },
            "hide": 0,
            "includeAll": false,
            "label": "Trino",
            "multi": false,
            "name": "DS_TRINO",
            "options": [],
            "query": "trino-datasource",
            "refresh": 1,
            "regex": "",
            "skipUrlSync": false,
            "type": "datasource"
          }
        ]
      },
      "time": {
        "from": "now-24h",
        "to": "now"
      },
      "timepicker": {},
      "timezone": "browser",
      "title": "Platform Operations",
      "uid": "platform-operations",
      "version": 1,
      "weekStart": ""
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-alerting-rules
  labels:
    app: grafana
data:
  rules.yml: |
    apiVersion: 1

    groups:
      - name: resource_thresholds
        folder: Monitoring
        interval: 1m
        rules:
          - uid: simulation_memory_high
            title: High Simulation Memory Usage
            condition: A
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: (container_memory_working_set_bytes{name="rideshare-simulation"} / container_spec_memory_limit_bytes{name="rideshare-simulation"}) > 0.9
                  refId: A
            noDataState: NoData
            execErrState: Alerting
            for: 5m
            annotations:
              description: Simulation container is using more than 90% of allocated memory
              summary: High memory usage on Simulation
            labels:
              severity: warning
              component: simulation

          - uid: stream_processor_memory_high
            title: High Stream Processor Memory Usage
            condition: A
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: (container_memory_working_set_bytes{name="rideshare-stream-processor"} / container_spec_memory_limit_bytes{name="rideshare-stream-processor"}) > 0.9
                  refId: A
            noDataState: NoData
            execErrState: Alerting
            for: 5m
            annotations:
              description: Stream processor container is using more than 90% of allocated memory
              summary: High memory usage on Stream Processor
            labels:
              severity: warning
              component: stream-processor

          - uid: kafka_memory_high
            title: High Kafka Memory Usage
            condition: A
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: (container_memory_working_set_bytes{name="rideshare-kafka"} / container_spec_memory_limit_bytes{name="rideshare-kafka"}) > 0.9
                  refId: A
            noDataState: NoData
            execErrState: Alerting
            for: 5m
            annotations:
              description: Kafka container is using more than 90% of allocated memory
              summary: High memory usage on Kafka
            labels:
              severity: warning
              component: kafka

          - uid: container_cpu_high
            title: High Container CPU Usage
            condition: A
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: rate(container_cpu_usage_seconds_total{name=~"rideshare-.*"}[5m]) > 0.8
                  refId: A
            noDataState: NoData
            execErrState: Alerting
            for: 5m
            annotations:
              description: Container CPU usage has exceeded 80% for 5 minutes
              summary: High CPU usage detected
            labels:
              severity: warning
              component: infrastructure

      - name: simulation_alerts
        folder: Monitoring
        interval: 1m
        rules:
          - uid: simulation_error_rate_high
            title: High Simulation Error Rate
            condition: A
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: sum(rate(simulation_errors_total[5m])) > 10
                  refId: A
            noDataState: NoData
            execErrState: Alerting
            for: 2m
            annotations:
              description: Simulation is experiencing high error rate
              summary: High error rate in simulation
            labels:
              severity: warning
              component: simulation

          - uid: stream_processor_kafka_disconnected
            title: Stream Processor Kafka Disconnected
            condition: A
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: stream_processor_kafka_connected == 0
                  refId: A
            noDataState: NoData
            execErrState: Alerting
            for: 1m
            annotations:
              description: Stream processor has lost connection to Kafka
              summary: Kafka connection lost
            labels:
              severity: critical
              component: stream-processor

          - uid: stream_processor_redis_disconnected
            title: Stream Processor Redis Disconnected
            condition: A
            data:
              - refId: A
                relativeTimeRange:
                  from: 300
                  to: 0
                datasourceUid: prometheus
                model:
                  expr: stream_processor_redis_connected == 0
                  refId: A
            noDataState: NoData
            execErrState: Alerting
            for: 1m
            annotations:
              description: Stream processor has lost connection to Redis
              summary: Redis connection lost
            labels:
              severity: critical
              component: stream-processor

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: grafana
  labels:
    app: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template:
    metadata:
      labels:
        app: grafana
    spec:
      initContainers:
      - name: wait-for-prometheus
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z prometheus 9090; do
            echo "Waiting for Prometheus..."
            sleep 2
          done
          echo "Prometheus is ready"
      - name: wait-for-loki
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z loki 3100; do
            echo "Waiting for Loki..."
            sleep 2
          done
          echo "Loki is ready"
      - name: wait-for-tempo
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z tempo 3200; do
            echo "Waiting for Tempo..."
            sleep 2
          done
          echo "Tempo is ready"
      containers:
      - name: grafana
        image: grafana/grafana:12.3.1
        resources:
          limits:
            memory: "384Mi"
          requests:
            memory: "192Mi"
        ports:
        - containerPort: 3000
          name: web
        env:
        - name: GF_SECURITY_ADMIN_USER
          valueFrom:
            secretKeyRef:
              name: app-credentials
              key: GRAFANA_ADMIN_USER
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: app-credentials
              key: GRAFANA_ADMIN_PASSWORD
        - name: GF_PATHS_PROVISIONING
          value: /etc/grafana/provisioning
        - name: GF_SERVER_ROOT_URL
          value: http://localhost:3001
        - name: GF_AUTH_ANONYMOUS_ENABLED
          value: "false"
        - name: GF_INSTALL_PLUGINS
          value: trino-datasource
        livenessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /api/health
            port: 3000
          initialDelaySeconds: 10
          periodSeconds: 5
        volumeMounts:
        - name: datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: data
          mountPath: /var/lib/grafana
        - name: dashboard-provider
          mountPath: /etc/grafana/provisioning/dashboards
        - name: dashboards-monitoring
          mountPath: /etc/dashboards/monitoring
        - name: dashboards-data-engineering
          mountPath: /etc/dashboards/data-engineering
        - name: dashboards-business-intelligence
          mountPath: /etc/dashboards/business-intelligence
        - name: dashboards-operations
          mountPath: /etc/dashboards/operations
        - name: alerting-rules
          mountPath: /etc/grafana/provisioning/alerting
      volumes:
      - name: datasources
        configMap:
          name: grafana-datasources
      - name: dashboard-provider
        configMap:
          name: grafana-dashboard-provider
      - name: dashboards-monitoring
        configMap:
          name: grafana-dashboards-monitoring
      - name: dashboards-data-engineering
        configMap:
          name: grafana-dashboards-data-engineering
      - name: dashboards-business-intelligence
        configMap:
          name: grafana-dashboards-business-intelligence
      - name: dashboards-operations
        configMap:
          name: grafana-dashboards-operations
      - name: alerting-rules
        configMap:
          name: grafana-alerting-rules
      - name: data
        emptyDir: {}

---
apiVersion: v1
kind: Service
metadata:
  name: grafana
  labels:
    app: grafana
spec:
  type: ClusterIP
  ports:
  - port: 3001
    targetPort: 3000
    name: web
  selector:
    app: grafana
