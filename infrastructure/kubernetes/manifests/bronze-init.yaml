apiVersion: v1
kind: ConfigMap
metadata:
  name: bronze-init-scripts
  labels:
    app: bronze-init
data:
  wait-for-thrift-and-init-bronze.sh: |
    #!/bin/bash
    set -e

    echo "================================================================"
    echo "Bronze Layer Initialization Service"
    echo "================================================================"

    # Wait for Spark Thrift Server to be ready
    echo "Waiting for Spark Thrift Server to be ready..."
    MAX_RETRIES=30
    RETRY_COUNT=0

    while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
      if nc -z spark-thrift-server 10000 2>/dev/null; then
        echo "Spark Thrift Server is ready"
        break
      fi

      RETRY_COUNT=$((RETRY_COUNT + 1))
      echo "  Attempt $RETRY_COUNT/$MAX_RETRIES: Thrift Server not ready yet, waiting..."
      sleep 5
    done

    if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
      echo "Timed out waiting for Spark Thrift Server"
      exit 1
    fi

    # Additional wait to ensure Thrift Server is fully initialized
    echo "Waiting additional 5 seconds for Thrift Server to fully initialize..."
    sleep 5

    # Run Bronze initialization
    echo "Running Bronze metastore initialization..."
    python3 /opt/init-scripts/init-bronze-metastore.py

    # Exit with success code
    echo "================================================================"
    echo "Bronze initialization complete"
    echo "================================================================"
    exit 0

  init-bronze-metastore.py: |
    """Initialize Bronze layer Delta Lake tables in the Hive Metastore via Spark Thrift Server."""
    from pyhive import hive
    import time

    THRIFT_HOST = "spark-thrift-server"
    THRIFT_PORT = 10000

    # Bronze tables to register (topic name -> Delta Lake path)
    BRONZE_TABLES = {
        "gps_pings": "s3a://rideshare-bronze/gps_pings",
        "trips": "s3a://rideshare-bronze/trips",
        "driver_status": "s3a://rideshare-bronze/driver_status",
        "surge_updates": "s3a://rideshare-bronze/surge_updates",
        "ratings": "s3a://rideshare-bronze/ratings",
        "payments": "s3a://rideshare-bronze/payments",
        "driver_profiles": "s3a://rideshare-bronze/driver_profiles",
        "rider_profiles": "s3a://rideshare-bronze/rider_profiles",
    }

    def connect_with_retry(host: str, port: int, max_retries: int = 5) -> hive.Connection:
        for attempt in range(1, max_retries + 1):
            try:
                conn = hive.connect(host=host, port=port, auth="NOSASL")
                print(f"Connected to Thrift Server at {host}:{port}")
                return conn
            except Exception as e:
                print(f"  Attempt {attempt}/{max_retries}: Connection failed: {e}")
                if attempt < max_retries:
                    time.sleep(5)
        raise ConnectionError(f"Failed to connect after {max_retries} attempts")

    def main() -> None:
        conn = connect_with_retry(THRIFT_HOST, THRIFT_PORT)
        cursor = conn.cursor()

        # Create database if not exists
        cursor.execute("CREATE DATABASE IF NOT EXISTS bronze")
        print("Database 'bronze' ready")

        # Register each Delta table
        for table_name, path in BRONZE_TABLES.items():
            full_name = f"bronze.{table_name}"
            try:
                cursor.execute(
                    f"CREATE TABLE IF NOT EXISTS {full_name} "
                    f"USING DELTA LOCATION '{path}'"
                )
                print(f"  Registered: {full_name} -> {path}")
            except Exception as e:
                # Table may not exist yet if no data has been written
                print(f"  Skipped {full_name}: {e}")

        cursor.close()
        conn.close()
        print("Bronze metastore initialization complete")

    if __name__ == "__main__":
        main()

---
apiVersion: batch/v1
kind: Job
metadata:
  name: bronze-init
  labels:
    app: bronze-init
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: bronze-init
    spec:
      initContainers:
      - name: wait-for-spark-thrift-server
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z spark-thrift-server 10000; do
            echo "Waiting for Spark Thrift Server..."
            sleep 5
          done
          echo "Spark Thrift Server is ready"
      containers:
      - name: bronze-init
        image: apache/airflow:3.1.5
        command:
        - bash
        - -c
        - |
          pip install pyhive thrift --quiet &&
          bash /opt/init-scripts/wait-for-thrift-and-init-bronze.sh
        env:
        - name: _PIP_ADDITIONAL_REQUIREMENTS
          value: pyhive thrift
        volumeMounts:
        - name: scripts
          mountPath: /opt/init-scripts
      restartPolicy: OnFailure
      volumes:
      - name: scripts
        configMap:
          name: bronze-init-scripts
          defaultMode: 0755
