apiVersion: v1
kind: ConfigMap
metadata:
  name: bronze-init-scripts
  labels:
    app: bronze-init
data:
  register-delta-tables.sh: |
    #!/bin/bash
    set -e

    # Register Delta table locations in Hive Metastore via Trino.
    # Replaces the old Spark Thrift / PyHive based initialization.
    # Idempotent - safe to re-run at any time.

    TRINO_HOST="${TRINO_HOST:-trino}"
    TRINO_PORT="${TRINO_PORT:-8080}"

    BRONZE_TABLES=(
        bronze_gps_pings
        bronze_trips
        bronze_driver_status
        bronze_surge_updates
        bronze_ratings
        bronze_payments
        bronze_driver_profiles
        bronze_rider_profiles
    )

    DLQ_TABLES=(
        dlq_bronze_gps_pings
        dlq_bronze_trips
        dlq_bronze_driver_status
        dlq_bronze_surge_updates
        dlq_bronze_ratings
        dlq_bronze_payments
        dlq_bronze_driver_profiles
        dlq_bronze_rider_profiles
    )

    REGISTERED=0
    SKIPPED=0
    FAILED=0

    execute_trino() {
        local sql="$1"
        trino --server "http://${TRINO_HOST}:${TRINO_PORT}" \
              --catalog delta \
              --schema default \
              --execute "$sql" 2>&1
    }

    wait_for_trino() {
        local max_retries=30
        local attempt=0

        echo "Waiting for Trino at ${TRINO_HOST}:${TRINO_PORT}..."

        while [ "$attempt" -lt "$max_retries" ]; do
            if execute_trino "SELECT 1" > /dev/null 2>&1; then
                echo "Trino is ready"
                return 0
            fi

            attempt=$((attempt + 1))
            echo "  Attempt ${attempt}/${max_retries}: Trino not ready, waiting 5s..."
            sleep 5
        done

        echo "ERROR: Timed out waiting for Trino"
        return 1
    }

    register_table() {
        local table_name="$1"
        local bucket="$2"
        local location="s3://${bucket}/${table_name}/"

        local existing
        existing=$(execute_trino "SHOW TABLES LIKE '${table_name}'" 2>/dev/null || true)
        if echo "$existing" | grep -q "${table_name}"; then
            echo "  [SKIP] ${table_name} - already registered"
            SKIPPED=$((SKIPPED + 1))
            return 0
        fi

        local output
        output=$(execute_trino "CALL delta.system.register_table(schema_name => 'default', table_name => '${table_name}', table_location => '${location}')" 2>&1)
        local exit_code=$?

        if [ "$exit_code" -eq 0 ]; then
            echo "  [OK] ${table_name} - registered at ${location}"
            REGISTERED=$((REGISTERED + 1))
            return 0
        fi

        echo "  [WARN] ${table_name} - not found at ${location} (data not ingested yet)"
        FAILED=$((FAILED + 1))
        return 0
    }

    echo "=============================================="
    echo "Delta Table Registration"
    echo "=============================================="

    wait_for_trino

    echo ""
    echo "--- Bronze Tables (${#BRONZE_TABLES[@]}) ---"
    for table in "${BRONZE_TABLES[@]}"; do
        register_table "$table" "$BRONZE_BUCKET"
    done

    echo ""
    echo "--- DLQ Tables (${#DLQ_TABLES[@]}) ---"
    for table in "${DLQ_TABLES[@]}"; do
        register_table "$table" "$BRONZE_BUCKET"
    done

    echo ""
    echo "=============================================="
    echo "Registration Summary"
    echo "=============================================="
    echo "  Registered: ${REGISTERED}"
    echo "  Skipped: ${SKIPPED}"
    echo "  Not found (no data yet): ${FAILED}"
    echo "Done"

---
apiVersion: batch/v1
kind: Job
metadata:
  name: bronze-init
  labels:
    app: bronze-init
spec:
  backoffLimit: 5
  template:
    metadata:
      labels:
        app: bronze-init
    spec:
      initContainers:
      - name: wait-for-trino
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z trino 8080; do
            echo "Waiting for Trino..."
            sleep 5
          done
          echo "Trino is ready"
      containers:
      - name: bronze-init
        image: trinodb/trino:439
        command:
        - bash
        - /opt/init-scripts/register-delta-tables.sh
        env:
        - name: TRINO_HOST
          value: trino
        - name: TRINO_PORT
          value: "8080"
        - name: BRONZE_BUCKET
          value: rideshare-bronze
        volumeMounts:
        - name: scripts
          mountPath: /opt/init-scripts
      restartPolicy: OnFailure
      volumes:
      - name: scripts
        configMap:
          name: bronze-init-scripts
          defaultMode: 0755
