apiVersion: v1
kind: ConfigMap
metadata:
  name: superset-init
  labels:
    app: superset
data:
  init.sh: |
    #!/bin/sh
    set -e
    echo 'Installing dependencies to Superset venv...'
    pip install --target=/app/.venv/lib/python3.10/site-packages pyhive thrift psycopg2-binary

    echo 'Running database migrations...'
    superset db upgrade

    echo 'Waiting for migrations to settle...'
    sleep 5

    echo 'Creating admin user...'
    superset fab create-admin --username admin --firstname Admin --lastname User --email admin@superset.com --password admin || true

    echo 'Initializing Superset (with retry)...'
    for i in 1 2 3 4 5; do
      superset init && break || {
        echo "Init attempt $i failed, retrying in 5 seconds...";
        sleep 5;
      }
    done

    echo 'Superset initialization complete!'

---
apiVersion: batch/v1
kind: Job
metadata:
  name: superset-init
  labels:
    app: superset-init
spec:
  template:
    metadata:
      labels:
        app: superset-init
    spec:
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-postgres
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z superset-postgres 5432; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done
          echo "PostgreSQL is ready"
      - name: wait-for-redis
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          until nc -z superset-redis 6379; do
            echo "Waiting for Redis..."
            sleep 2
          done
          echo "Redis is ready"
      containers:
      - name: superset-init
        image: apache/superset:6.0.0
        command:
        - /bin/sh
        - /app/init/init.sh
        env:
        - name: SUPERSET_SECRET_KEY
          value: dev-secret-key-change-in-production
        - name: DATABASE_HOST
          value: superset-postgres
        - name: DATABASE_PORT
          value: "5432"
        - name: DATABASE_DB
          value: superset
        - name: DATABASE_USER
          value: superset
        - name: DATABASE_PASSWORD
          value: superset
        - name: REDIS_HOST
          value: superset-redis
        - name: REDIS_PORT
          value: "6379"
        volumeMounts:
        - name: init-script
          mountPath: /app/init
      volumes:
      - name: init-script
        configMap:
          name: superset-init
          defaultMode: 0755

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: superset
  labels:
    app: superset
spec:
  replicas: 1
  selector:
    matchLabels:
      app: superset
  template:
    metadata:
      labels:
        app: superset
    spec:
      containers:
      - name: superset
        image: apache/superset:6.0.0
        command:
        - /bin/sh
        - -c
        - |
          pip install --target=/tmp/python-packages pyhive thrift psycopg2-binary
          exec gunicorn -w 2 --timeout 120 -b 0.0.0.0:8088 --limit-request-line 0 --limit-request-field_size 0 "superset.app:create_app()"
        resources:
          limits:
            memory: "512Mi"
          requests:
            memory: "256Mi"
        ports:
        - containerPort: 8088
          name: web
        env:
        - name: SUPERSET_SECRET_KEY
          value: dev-secret-key-change-in-production
        - name: DATABASE_HOST
          value: superset-postgres
        - name: DATABASE_PORT
          value: "5432"
        - name: DATABASE_DB
          value: superset
        - name: DATABASE_USER
          value: superset
        - name: DATABASE_PASSWORD
          value: superset
        - name: REDIS_HOST
          value: superset-redis
        - name: REDIS_PORT
          value: "6379"
        - name: PYTHONPATH
          value: /tmp/python-packages
        livenessProbe:
          httpGet:
            path: /health
            port: 8088
          initialDelaySeconds: 60
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8088
          initialDelaySeconds: 30
          periodSeconds: 5

---
apiVersion: v1
kind: Service
metadata:
  name: superset
  labels:
    app: superset
spec:
  type: ClusterIP
  ports:
  - port: 8088
    targetPort: 8088
    name: web
  selector:
    app: superset
