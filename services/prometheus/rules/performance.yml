groups:
  - name: rideshare_performance_headroom
    interval: 15s
    rules:
      # --- Individual headroom components (0-1, higher = healthier) ---

      - record: rideshare:performance:kafka_lag_headroom
        expr: clamp(1 - (sum(kafka_consumergroup_lag) or vector(0)) / 10000, 0, 1)

      - record: rideshare:performance:simpy_queue_headroom
        expr: clamp(1 - (max(simulation_simpy_events) or vector(0)) / 500, 0, 1)

      - record: rideshare:performance:cpu_headroom
        expr: >-
          clamp(
            1 - (max by() (rate(container_cpu_usage_seconds_total{name=~"rideshare.*"}[30s]) * 100) or vector(0)) / 85,
            0, 1
          )

      - record: rideshare:performance:memory_headroom
        expr: >-
          clamp(
            1 - (max by() (container_memory_working_set_bytes{name=~"rideshare.*"}
              / (container_spec_memory_limit_bytes{name=~"rideshare.*"} > 0) * 100) or vector(0)) / 85,
            0, 1
          )

      - record: rideshare:performance:consumption_ratio
        expr: >-
          clamp(
            (sum(rate(stream_processor_messages_consumed_total[30s])) or vector(0))
            / clamp_min(sum(rate(simulation_events_total[30s])) or vector(0.1), 0.1),
            0, 1
          )

      - record: rideshare:performance:rtr_headroom
        expr: clamp(simulation_real_time_ratio or vector(0), 0, 1)

  - name: rideshare_performance_composite
    interval: 15s
    rules:
      # --- Composite index = min of all components ---
      - record: rideshare:performance:index
        expr: >-
          min by() (
            label_replace(rideshare:performance:kafka_lag_headroom, "component", "kafka_lag", "", "")
            or label_replace(rideshare:performance:simpy_queue_headroom, "component", "simpy_queue", "", "")
            or label_replace(rideshare:performance:cpu_headroom, "component", "cpu", "", "")
            or label_replace(rideshare:performance:memory_headroom, "component", "memory", "", "")
            or label_replace(rideshare:performance:consumption_ratio, "component", "consumption", "", "")
            or label_replace(rideshare:performance:rtr_headroom, "component", "rtr", "", "")
          )
