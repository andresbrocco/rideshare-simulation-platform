apiVersion: 1

groups:
  - name: resource_thresholds
    folder: Monitoring
    interval: 1m
    rules:
      - uid: simulation_memory_high
        title: High Simulation Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (container_memory_working_set_bytes{name="rideshare-simulation"} / container_spec_memory_limit_bytes{name="rideshare-simulation"}) > 0.9
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Simulation container is using more than 90% of allocated memory
          summary: High memory usage on Simulation
        labels:
          severity: warning
          component: simulation

      - uid: stream_processor_memory_high
        title: High Stream Processor Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (container_memory_working_set_bytes{name="rideshare-stream-processor"} / container_spec_memory_limit_bytes{name="rideshare-stream-processor"}) > 0.9
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Stream processor container is using more than 90% of allocated memory
          summary: High memory usage on Stream Processor
        labels:
          severity: warning
          component: stream-processor

      - uid: kafka_memory_high
        title: High Kafka Memory Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: (container_memory_working_set_bytes{name="rideshare-kafka"} / container_spec_memory_limit_bytes{name="rideshare-kafka"}) > 0.9
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Kafka container is using more than 90% of allocated memory
          summary: High memory usage on Kafka
        labels:
          severity: warning
          component: kafka

      - uid: container_cpu_high
        title: High Container CPU Usage
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: rate(container_cpu_usage_seconds_total{name=~"rideshare-.*"}[5m]) > 0.8
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 5m
        annotations:
          description: Container CPU usage has exceeded 80% for 5 minutes
          summary: High CPU usage detected
        labels:
          severity: warning
          component: infrastructure

  - name: simulation_alerts
    folder: Monitoring
    interval: 1m
    rules:
      - uid: simulation_error_rate_high
        title: High Simulation Error Rate
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: sum(rate(simulation_errors_total[5m])) > 10
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 2m
        annotations:
          description: Simulation is experiencing high error rate
          summary: High error rate in simulation
        labels:
          severity: warning
          component: simulation

      - uid: stream_processor_kafka_disconnected
        title: Stream Processor Kafka Disconnected
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: stream_processor_kafka_connected == 0
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          description: Stream processor has lost connection to Kafka
          summary: Kafka connection lost
        labels:
          severity: critical
          component: stream-processor

      - uid: stream_processor_redis_disconnected
        title: Stream Processor Redis Disconnected
        condition: A
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              expr: stream_processor_redis_connected == 0
              refId: A
        noDataState: NoData
        execErrState: Alerting
        for: 1m
        annotations:
          description: Stream processor has lost connection to Redis
          summary: Redis connection lost
        labels:
          severity: critical
          component: stream-processor
