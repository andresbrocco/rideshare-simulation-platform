layers:
  bronze:
    description: "Raw Kafka events stored in Delta format with Kafka metadata. All tables contain _raw_value JSON column with the full event payload."
    tables:
      - name: bronze_trips
        description: "Raw trip events from Kafka including all trip state transitions (requested, matched, started, completed, cancelled, etc.)"
        location: "s3a://rideshare-bronze/bronze_trips/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload from Kafka message containing complete trip event data"
          - name: _kafka_partition
            type: integer
            description: "Kafka partition number (4 partitions for trips topic)"
          - name: _kafka_offset
            type: long
            description: "Kafka message offset within partition"
          - name: _kafka_timestamp
            type: timestamp
            description: "Kafka message timestamp (broker receipt time)"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer by Spark Structured Streaming"
          - name: _ingestion_date
            type: date
            description: "Date partition for ingestion (used for data organization)"

      - name: bronze_gps_pings
        description: "Raw GPS location pings from drivers and riders (highest volume topic with 8 partitions)"
        location: "s3a://rideshare-bronze/bronze_gps_pings/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload containing GPS coordinates, entity info, and accuracy metrics"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer"

      - name: bronze_driver_status
        description: "Raw driver status change events (online, offline, en_route_pickup, en_route_destination)"
        location: "s3a://rideshare-bronze/bronze_driver_status/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload with status transitions and location at time of change"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer"

      - name: bronze_surge_updates
        description: "Raw surge pricing update events by zone with demand/supply metrics"
        location: "s3a://rideshare-bronze/bronze_surge_updates/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload with surge multiplier changes and market conditions"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer"

      - name: bronze_ratings
        description: "Raw rating events from both drivers rating riders and riders rating drivers"
        location: "s3a://rideshare-bronze/bronze_ratings/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload with rating value (1-5) and rater/ratee information"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer"

      - name: bronze_payments
        description: "Raw payment transaction events with fare breakdown and payment method details"
        location: "s3a://rideshare-bronze/bronze_payments/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload with payment amounts, platform fees, and driver payouts"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer"

      - name: bronze_driver_profiles
        description: "Raw driver profile events (registration and updates) with vehicle and personal details"
        location: "s3a://rideshare-bronze/bronze_driver_profiles/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload with driver info, home location, shift preferences, and vehicle details"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer"

      - name: bronze_rider_profiles
        description: "Raw rider profile events (registration and updates) with payment method and behavior data"
        location: "s3a://rideshare-bronze/bronze_rider_profiles/"
        file_format: "delta"
        columns:
          - name: _raw_value
            type: string
            description: "Raw JSON payload with rider info, home location, payment methods, and behavior factors"
          - name: _ingested_at
            type: timestamp
            description: "Timestamp when record was written to Bronze layer"

  silver:
    description: "Cleaned, parsed, and deduplicated events from Bronze layer. Uses incremental materialization with merge strategy."
    tables:
      - name: stg_trips
        description: "Parsed trip events with extracted fields from raw JSON. Deduplicated on event_id."
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier (primary key, used for deduplication)"
          - name: event_type
            type: string
            description: "Full event type string (e.g., 'trip.requested', 'trip.matched')"
          - name: trip_state
            type: string
            description: "Extracted trip state (requested, offer_sent, offer_expired, offer_rejected, matched, driver_en_route, driver_arrived, started, completed, cancelled, no_drivers_available)"
          - name: timestamp
            type: timestamp
            description: "Event occurrence timestamp"
          - name: trip_id
            type: string
            description: "Trip identifier (not unique - one trip has many events)"
          - name: rider_id
            type: string
            description: "Rider identifier"
          - name: pickup_lat
            type: double
            description: "Pickup latitude coordinate"
          - name: pickup_lon
            type: double
            description: "Pickup longitude coordinate"
          - name: dropoff_lat
            type: double
            description: "Dropoff latitude coordinate"
          - name: dropoff_lon
            type: double
            description: "Dropoff longitude coordinate"
          - name: pickup_zone_id
            type: string
            description: "Pickup zone identifier (3-letter code)"
          - name: dropoff_zone_id
            type: string
            description: "Dropoff zone identifier (3-letter code)"
          - name: surge_multiplier
            type: double
            description: "Surge pricing multiplier at trip request time"
          - name: fare
            type: double
            description: "Total fare amount"
          - name: driver_id
            type: string
            description: "Driver identifier (null for unmatched trips)"
          - name: correlation_id
            type: string
            description: "Correlation ID for tracking related events"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp (used for incremental processing)"

      - name: stg_gps_pings
        description: "Parsed GPS ping events with location validation (Sao Paulo bounds check)"
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier"
          - name: entity_type
            type: string
            description: "Entity type (driver or rider)"
          - name: entity_id
            type: string
            description: "Driver or rider identifier"
          - name: timestamp
            type: timestamp
            description: "GPS ping timestamp"
          - name: latitude
            type: double
            description: "GPS latitude (-23.8 to -23.3 for Sao Paulo)"
          - name: longitude
            type: double
            description: "GPS longitude (-46.9 to -46.3 for Sao Paulo)"
          - name: location
            type: array<double>
            description: "Location array [latitude, longitude]"
          - name: accuracy
            type: double
            description: "GPS accuracy in meters"
          - name: heading
            type: double
            description: "Movement heading in degrees"
          - name: speed
            type: double
            description: "Speed in km/h"
          - name: trip_id
            type: string
            description: "Associated trip ID if in trip"
          - name: trip_state
            type: string
            description: "Trip state at time of ping"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp"

      - name: stg_driver_status
        description: "Parsed driver status change events with location at time of transition"
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier"
          - name: driver_id
            type: string
            description: "Driver identifier"
          - name: timestamp
            type: timestamp
            description: "Status change timestamp"
          - name: new_status
            type: string
            description: "New status (online, offline, en_route_pickup, en_route_destination)"
          - name: previous_status
            type: string
            description: "Previous status"
          - name: trigger
            type: string
            description: "What triggered the status change"
          - name: latitude
            type: double
            description: "Latitude at time of status change"
          - name: longitude
            type: double
            description: "Longitude at time of status change"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp"

      - name: stg_surge_updates
        description: "Parsed surge pricing updates with validation (multiplier between 1.0 and 2.5)"
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier"
          - name: zone_id
            type: string
            description: "Zone identifier (3-letter code)"
          - name: timestamp
            type: timestamp
            description: "Surge update timestamp"
          - name: previous_multiplier
            type: double
            description: "Previous surge multiplier (1.0-2.5)"
          - name: new_multiplier
            type: double
            description: "New surge multiplier (1.0-2.5)"
          - name: available_drivers
            type: integer
            description: "Number of available drivers in zone"
          - name: pending_requests
            type: integer
            description: "Number of pending trip requests in zone"
          - name: calculation_window_seconds
            type: integer
            description: "Time window used for surge calculation"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp"

      - name: stg_ratings
        description: "Parsed rating events with validation (rating between 1 and 5)"
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier"
          - name: trip_id
            type: string
            description: "Associated trip identifier"
          - name: timestamp
            type: timestamp
            description: "Rating timestamp"
          - name: rater_type
            type: string
            description: "Type of entity giving rating (driver or rider)"
          - name: rater_id
            type: string
            description: "ID of entity giving rating"
          - name: ratee_type
            type: string
            description: "Type of entity being rated (driver or rider)"
          - name: ratee_id
            type: string
            description: "ID of entity being rated"
          - name: rating
            type: integer
            description: "Rating value (1-5 stars)"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp"

      - name: stg_payments
        description: "Parsed payment events with fare breakdown validation (amounts must be positive)"
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier"
          - name: payment_id
            type: string
            description: "Payment transaction identifier"
          - name: trip_id
            type: string
            description: "Associated trip identifier"
          - name: timestamp
            type: timestamp
            description: "Payment timestamp"
          - name: rider_id
            type: string
            description: "Rider identifier"
          - name: driver_id
            type: string
            description: "Driver identifier"
          - name: payment_method_type
            type: string
            description: "Payment method type (credit_card, debit_card, etc.)"
          - name: payment_method_masked
            type: string
            description: "Masked payment method details (last 4 digits)"
          - name: fare_amount
            type: double
            description: "Total fare amount"
          - name: platform_fee_percentage
            type: double
            description: "Platform fee percentage (typically 0.25 = 25%)"
          - name: platform_fee_amount
            type: double
            description: "Platform fee amount in currency"
          - name: driver_payout_amount
            type: double
            description: "Amount paid out to driver"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp"

      - name: stg_drivers
        description: "Parsed driver profile events with personal and vehicle information"
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier"
          - name: event_type
            type: string
            description: "Event type (driver.registered, driver.updated)"
          - name: driver_id
            type: string
            description: "Driver identifier"
          - name: timestamp
            type: timestamp
            description: "Profile event timestamp"
          - name: first_name
            type: string
            description: "Driver first name"
          - name: last_name
            type: string
            description: "Driver last name"
          - name: email
            type: string
            description: "Driver email address"
          - name: phone
            type: string
            description: "Driver phone number"
          - name: home_lat
            type: double
            description: "Home location latitude"
          - name: home_lon
            type: double
            description: "Home location longitude"
          - name: preferred_zones
            type: string
            description: "Preferred operating zones (JSON array)"
          - name: shift_preference
            type: string
            description: "Shift preference (day, night, flexible)"
          - name: vehicle_make
            type: string
            description: "Vehicle manufacturer"
          - name: vehicle_model
            type: string
            description: "Vehicle model"
          - name: vehicle_year
            type: integer
            description: "Vehicle year"
          - name: license_plate
            type: string
            description: "Vehicle license plate number"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp"

      - name: stg_riders
        description: "Parsed rider profile events with payment method and behavior data"
        columns:
          - name: event_id
            type: string
            description: "Unique event identifier"
          - name: event_type
            type: string
            description: "Event type (rider.registered, rider.updated)"
          - name: rider_id
            type: string
            description: "Rider identifier"
          - name: timestamp
            type: timestamp
            description: "Profile event timestamp"
          - name: first_name
            type: string
            description: "Rider first name"
          - name: last_name
            type: string
            description: "Rider last name"
          - name: email
            type: string
            description: "Rider email address"
          - name: phone
            type: string
            description: "Rider phone number"
          - name: home_lat
            type: double
            description: "Home location latitude"
          - name: home_lon
            type: double
            description: "Home location longitude"
          - name: payment_method_type
            type: string
            description: "Payment method type"
          - name: payment_method_masked
            type: string
            description: "Masked payment method details"
          - name: behavior_factor
            type: double
            description: "Rider behavior factor (DNA parameter)"
          - name: _ingested_at
            type: timestamp
            description: "Bronze layer ingestion timestamp"

  gold:
    description: "Business-ready dimensional model (star schema) with dimensions, facts, and aggregates for analytics"
    dimensions:
      - name: dim_drivers
        description: "Driver dimension with SCD Type 2 for tracking historical vehicle and profile changes"
        columns:
          - name: driver_key
            type: string
            description: "Surrogate key (hash of driver_id + valid_from)"
          - name: driver_id
            type: string
            description: "Natural key - driver business identifier"
          - name: first_name
            type: string
            description: "Driver first name"
          - name: last_name
            type: string
            description: "Driver last name"
          - name: email
            type: string
            description: "Driver email address"
          - name: phone
            type: string
            description: "Driver phone number"
          - name: home_lat
            type: double
            description: "Home location latitude"
          - name: home_lon
            type: double
            description: "Home location longitude"
          - name: preferred_zones
            type: string
            description: "Preferred operating zones"
          - name: shift_preference
            type: string
            description: "Shift preference"
          - name: vehicle_make
            type: string
            description: "Vehicle manufacturer"
          - name: vehicle_model
            type: string
            description: "Vehicle model"
          - name: vehicle_year
            type: integer
            description: "Vehicle year"
          - name: license_plate
            type: string
            description: "Vehicle license plate"
          - name: valid_from
            type: timestamp
            description: "SCD Type 2 - start of validity period"
          - name: valid_to
            type: date
            description: "SCD Type 2 - end of validity period (9999-12-31 for current)"
          - name: current_flag
            type: boolean
            description: "SCD Type 2 - true if current version"

      - name: dim_riders
        description: "Rider dimension with current state only (no history tracking)"
        columns:
          - name: rider_key
            type: string
            description: "Surrogate key (hash of rider_id)"
          - name: rider_id
            type: string
            description: "Natural key - rider business identifier"
          - name: first_name
            type: string
            description: "Rider first name"
          - name: last_name
            type: string
            description: "Rider last name"
          - name: email
            type: string
            description: "Rider email address"
          - name: phone
            type: string
            description: "Rider phone number"
          - name: home_lat
            type: double
            description: "Home location latitude"
          - name: home_lon
            type: double
            description: "Home location longitude"
          - name: payment_method_type
            type: string
            description: "Current payment method type"
          - name: payment_method_masked
            type: string
            description: "Masked payment method details"
          - name: behavior_factor
            type: double
            description: "Rider behavior factor"
          - name: last_updated_at
            type: timestamp
            description: "Timestamp of last profile update"

      - name: dim_zones
        description: "Geographic zones dimension (static reference data from seed file)"
        columns:
          - name: zone_key
            type: string
            description: "Surrogate key (hash of zone_id)"
          - name: zone_id
            type: string
            description: "Natural key - 3-letter zone code (e.g., PIR, SDO)"
          - name: name
            type: string
            description: "Zone name (e.g., PIRITUBA)"
          - name: subprefecture
            type: string
            description: "Subprefecture name (e.g., PIRITUBA-JARAGUA)"
          - name: demand_multiplier
            type: double
            description: "Base demand multiplier for zone"
          - name: surge_sensitivity
            type: double
            description: "Surge pricing sensitivity factor"

      - name: dim_time
        description: "Time dimension with date attributes (pre-generated for 2024-2026)"
        columns:
          - name: time_key
            type: string
            description: "Surrogate key (hash of date_day)"
          - name: date_key
            type: date
            description: "Calendar date"
          - name: year
            type: integer
            description: "Year"
          - name: month
            type: integer
            description: "Month (1-12)"
          - name: day
            type: integer
            description: "Day of month (1-31)"
          - name: day_of_week
            type: integer
            description: "Day of week (1=Monday, 7=Sunday, ISO standard)"
          - name: is_weekend
            type: boolean
            description: "True if Saturday or Sunday"
          - name: day_name
            type: string
            description: "Day name (e.g., Monday)"
          - name: month_name
            type: string
            description: "Month name (e.g., January)"
          - name: quarter
            type: integer
            description: "Quarter (1-4)"

      - name: dim_payment_methods
        description: "Payment methods dimension with SCD Type 2 for tracking changes to rider payment methods"
        columns:
          - name: payment_method_key
            type: string
            description: "Surrogate key (hash of payment_method_id + valid_from)"
          - name: payment_method_id
            type: string
            description: "Generated ID (hash of rider_id + payment_method_type + masked)"
          - name: rider_id
            type: string
            description: "Associated rider identifier"
          - name: payment_method_type
            type: string
            description: "Payment method type"
          - name: payment_method_masked
            type: string
            description: "Masked payment method details"
          - name: valid_from
            type: timestamp
            description: "SCD Type 2 - start of validity period"
          - name: valid_to
            type: date
            description: "SCD Type 2 - end of validity period"
          - name: current_flag
            type: boolean
            description: "SCD Type 2 - true if current version"

    facts:
      - name: fact_trips
        description: "Completed trips with fare metrics and journey details (grain: one row per completed trip)"
        columns:
          - name: trip_key
            type: string
            description: "Surrogate key (hash of trip_id)"
          - name: trip_id
            type: string
            description: "Natural key - trip business identifier"
          - name: driver_key
            type: string
            description: "Foreign key to dim_drivers (temporal join)"
          - name: rider_key
            type: string
            description: "Foreign key to dim_riders"
          - name: pickup_zone_key
            type: string
            description: "Foreign key to dim_zones (pickup)"
          - name: dropoff_zone_key
            type: string
            description: "Foreign key to dim_zones (dropoff)"
          - name: time_key
            type: string
            description: "Foreign key to dim_time (completion date)"
          - name: trip_state
            type: string
            description: "Trip state (always 'completed' in this fact)"
          - name: requested_at
            type: timestamp
            description: "Trip request timestamp"
          - name: matched_at
            type: timestamp
            description: "Driver match timestamp"
          - name: started_at
            type: timestamp
            description: "Trip start timestamp"
          - name: completed_at
            type: timestamp
            description: "Trip completion timestamp"
          - name: pickup_lat
            type: double
            description: "Pickup latitude"
          - name: pickup_lon
            type: double
            description: "Pickup longitude"
          - name: dropoff_lat
            type: double
            description: "Dropoff latitude"
          - name: dropoff_lon
            type: double
            description: "Dropoff longitude"
          - name: fare
            type: double
            description: "Total fare amount"
          - name: surge_multiplier
            type: double
            description: "Surge multiplier applied"
          - name: distance_km
            type: double
            description: "Trip distance in kilometers (currently null, reserved for future)"
          - name: duration_minutes
            type: double
            description: "Trip duration from start to completion in minutes"

      - name: fact_payments
        description: "Payment transactions with fare breakdown (grain: one row per payment)"
        columns:
          - name: payment_key
            type: string
            description: "Surrogate key (hash of payment_id)"
          - name: payment_id
            type: string
            description: "Natural key - payment transaction identifier"
          - name: trip_key
            type: string
            description: "Foreign key to fact_trips"
          - name: rider_key
            type: string
            description: "Foreign key to dim_riders"
          - name: driver_key
            type: string
            description: "Foreign key to dim_drivers (temporal join)"
          - name: payment_method_key
            type: string
            description: "Foreign key to dim_payment_methods (temporal join)"
          - name: time_key
            type: string
            description: "Foreign key to dim_time (payment date)"
          - name: payment_timestamp
            type: timestamp
            description: "Payment transaction timestamp"
          - name: total_fare
            type: double
            description: "Total fare amount"
          - name: platform_fee
            type: double
            description: "Platform fee (25% of total_fare)"
          - name: driver_payout
            type: double
            description: "Driver payout (75% of total_fare)"
          - name: payment_method_type
            type: string
            description: "Payment method type (denormalized)"

      - name: fact_ratings
        description: "Individual ratings with rater and ratee information (grain: one row per rating)"
        columns:
          - name: rating_key
            type: string
            description: "Surrogate key (hash of event_id)"
          - name: trip_key
            type: string
            description: "Foreign key to fact_trips"
          - name: rater_key
            type: string
            description: "Surrogate key of entity giving rating (driver_key or rider_key)"
          - name: ratee_key
            type: string
            description: "Surrogate key of entity being rated (driver_key or rider_key)"
          - name: time_key
            type: string
            description: "Foreign key to dim_time (rating date)"
          - name: rating_timestamp
            type: timestamp
            description: "Rating timestamp"
          - name: rater_type
            type: string
            description: "Type of rater (driver or rider)"
          - name: ratee_type
            type: string
            description: "Type of ratee (driver or rider)"
          - name: rating
            type: integer
            description: "Rating value (1-5 stars)"

      - name: fact_cancellations
        description: "Cancelled trips with cancellation details (grain: one row per cancelled trip)"
        columns:
          - name: cancellation_key
            type: string
            description: "Surrogate key (hash of trip_id)"
          - name: trip_id
            type: string
            description: "Natural key - trip business identifier"
          - name: driver_key
            type: string
            description: "Foreign key to dim_drivers (temporal join, may be null)"
          - name: rider_key
            type: string
            description: "Foreign key to dim_riders"
          - name: pickup_zone_key
            type: string
            description: "Foreign key to dim_zones"
          - name: time_key
            type: string
            description: "Foreign key to dim_time (cancellation date)"
          - name: requested_at
            type: timestamp
            description: "Trip request timestamp"
          - name: cancelled_at
            type: timestamp
            description: "Cancellation timestamp"
          - name: cancellation_stage
            type: string
            description: "Trip state at cancellation (last state before cancelled)"
          - name: cancellation_reason
            type: string
            description: "Cancellation reason (currently null, reserved for future)"
          - name: surge_multiplier
            type: double
            description: "Surge multiplier at request time"

      - name: fact_driver_activity
        description: "Driver status durations for utilization analysis (grain: one row per status period)"
        columns:
          - name: activity_key
            type: string
            description: "Surrogate key (hash of driver_id + status_start)"
          - name: driver_key
            type: string
            description: "Foreign key to dim_drivers (temporal join)"
          - name: time_key
            type: string
            description: "Foreign key to dim_time (status start date)"
          - name: status
            type: string
            description: "Driver status (online, offline, en_route, on_trip)"
          - name: status_start
            type: timestamp
            description: "Status period start timestamp"
          - name: status_end
            type: timestamp
            description: "Status period end timestamp"
          - name: duration_minutes
            type: double
            description: "Duration of status period in minutes"
          - name: zone_key
            type: string
            description: "Zone key (currently null, reserved for future)"

    aggregates:
      - name: agg_hourly_zone_demand
        description: "Hourly demand and supply metrics by zone for demand forecasting (grain: zone + hour)"
        columns:
          - name: zone_key
            type: string
            description: "Foreign key to dim_zones"
          - name: hour_timestamp
            type: timestamp
            description: "Hour bucket timestamp (truncated to hour)"
          - name: requested_trips
            type: long
            description: "Number of trips requested in hour"
          - name: completed_trips
            type: long
            description: "Number of trips completed in hour"
          - name: avg_surge_multiplier
            type: double
            description: "Average surge multiplier for completed trips"
          - name: avg_wait_time_minutes
            type: double
            description: "Average wait time from match to start"
          - name: completion_rate
            type: double
            description: "Completion rate (completed / requested, 0.0-1.0)"

      - name: agg_daily_driver_performance
        description: "Daily driver KPIs including utilization and earnings (grain: driver + date)"
        columns:
          - name: driver_key
            type: string
            description: "Foreign key to dim_drivers"
          - name: time_key
            type: string
            description: "Foreign key to dim_time"
          - name: trips_completed
            type: long
            description: "Number of trips completed"
          - name: total_payout
            type: double
            description: "Total driver earnings for day"
          - name: avg_rating
            type: double
            description: "Average rating received (1.0-5.0)"
          - name: online_minutes
            type: double
            description: "Minutes in online status"
          - name: en_route_minutes
            type: double
            description: "Minutes in en_route status"
          - name: on_trip_minutes
            type: double
            description: "Minutes in on_trip status"
          - name: utilization_pct
            type: double
            description: "Utilization percentage ((en_route + on_trip) / online * 100)"

      - name: agg_daily_platform_revenue
        description: "Daily revenue and fees by zone (grain: zone + date)"
        columns:
          - name: zone_key
            type: string
            description: "Foreign key to dim_zones"
          - name: time_key
            type: string
            description: "Foreign key to dim_time"
          - name: total_trips
            type: long
            description: "Number of trips"
          - name: total_revenue
            type: double
            description: "Total fare revenue"
          - name: total_platform_fees
            type: double
            description: "Total platform fees collected (25% of revenue)"
          - name: total_driver_payouts
            type: double
            description: "Total driver payouts (75% of revenue)"
          - name: avg_fare
            type: double
            description: "Average fare per trip"

      - name: agg_surge_history
        description: "Surge pricing trends over time by zone (grain: zone + hour)"
        columns:
          - name: zone_key
            type: string
            description: "Foreign key to dim_zones"
          - name: hour_timestamp
            type: timestamp
            description: "Hour bucket timestamp"
          - name: avg_surge_multiplier
            type: double
            description: "Average surge multiplier"
          - name: max_surge_multiplier
            type: double
            description: "Maximum surge multiplier"
          - name: min_surge_multiplier
            type: double
            description: "Minimum surge multiplier"
          - name: avg_available_drivers
            type: double
            description: "Average available drivers"
          - name: avg_pending_requests
            type: double
            description: "Average pending requests"
          - name: surge_update_count
            type: long
            description: "Number of surge updates in hour"

notes:
  - "All timestamp columns are in UTC"
  - "Bronze layer uses Delta Lake format for ACID transactions and time travel"
  - "Silver layer uses incremental materialization with merge strategy and event_id deduplication"
  - "Gold layer uses full refresh on each dbt run"
  - "SCD Type 2 dimensions (dim_drivers, dim_payment_methods) use temporal joins with valid_from/valid_to"
  - "Fact tables join dimensions using surrogate keys (driver_key, rider_key, zone_key, etc.)"
  - "Platform fee is fixed at 25% of total fare"
  - "Driver payout is fixed at 75% of total fare"
  - "GPS coordinates are validated to Sao Paulo bounds (lat: -23.8 to -23.3, lon: -46.9 to -46.3)"
  - "Surge multipliers are constrained between 1.0 and 2.5"
  - "Ratings are constrained between 1 and 5"
